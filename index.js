"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_slicedToArray=function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return function(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}!function(){var srcmap={palette:[17,210,5,6],"select-glow":[70,182,16,18],"icon-ice":[208,77,10,10],"icon8-sword":[17,202,8,8],"select-cursor":[0,202,17,17],"icon6-hat":[110,208,6,6],"icon6-dagger":[184,34,6,6],tag:[208,87,5,12],"select-arrows":[120,0,64,64],"icon6-shield":[194,24,6,6],"icon6-bow":[190,64,6,6],"icon-fire":[100,208,10,10],"icon8-axe":[70,200,8,8],"font-serif":[0,0,120,77],"icon-volt":[184,24,10,10],"icon6-cudgel":[69,170,6,6],"icon-dark":[180,64,10,10],"font-six":[168,178,50,12],buttons:[0,140,69,42],"font-smallcaps":[170,115,50,20],"font-smallcaps-radiant":[100,194,80,14],bars:[100,140,68,27],"font-numbers":[120,64,60,12],"icon8-shield":[86,182,8,8],"icon8-dagger":[206,158,8,8],"font-standard":[100,77,70,63],hp:[168,140,38,38],"icon8-hat":[180,208,8,8],labels:[206,140,13,18],"icon6-sword":[79,160,6,6],"icon8-bow":[194,194,8,8],piece:[180,194,14,14],"icon-holy":[69,160,10,10],"font-standard-bold":[0,77,100,63],"icon-plant":[89,140,10,10],vs:[170,77,38,38],"icon6-axe":[89,150,6,6],bar:[100,167,68,27],"select-ring":[69,140,20,20],"font-smallcaps-bold":[0,182,70,20],badges:[184,0,32,24]},fonts={standard:{id:"standard",cellsize:{width:7,height:9},charsize:{width:5,height:7},exceptions:{1:{width:3},I:{width:3},f:{width:5},g:{height:9},i:{width:1},j:{width:2,height:8},l:{width:1,x:0},m:{width:7},p:{height:9},q:{height:9},r:{width:4},t:{width:4},w:{width:9},y:{height:9},",":{width:2,height:9},".":{width:1},"!":{width:1},"'":{width:1},"(":{width:3},")":{width:3}},spacing:{char:1,word:4,line:5},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.!?","abcdefghij","klmnopqrst","uvwxyz'()"]},standardBold:{id:"standard-bold",cellsize:{width:10,height:9},charsize:{width:6,height:7},exceptions:{1:{width:4},I:{width:4},J:{width:5},M:{width:7},W:{width:7},f:{width:5},g:{height:9},i:{width:2},j:{width:5},l:{width:2,x:0},m:{width:10},p:{height:9},q:{height:9},w:{width:10},y:{height:9},",":{width:2,height:8},".":{width:2},"!":{width:2},"?":{width:6},"'":{width:2},"(":{width:4},")":{width:4}},spacing:{char:1,word:4,line:5},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.!?","abcdefghij","klmnopqrst","uvwxyz'()"]},serif:{id:"serif",cellsize:{width:12,height:11},charsize:{width:8,height:9},exceptions:{A:{width:9},D:{width:9},H:{width:9},I:{width:4},J:{width:5},K:{width:9},M:{width:10},N:{width:9},Q:{width:9,height:11},S:{width:7},U:{width:9},a:{width:7},b:{width:7},c:{width:6},d:{width:7},e:{width:6},f:{width:5},g:{width:7,height:11},h:{width:8},i:{width:4},j:{width:4,height:11},k:{width:8},l:{width:4},m:{width:12},n:{width:8},o:{width:6},p:{width:7,height:11},q:{width:7,height:11},r:{width:7},s:{width:6},t:{width:5},v:{width:7},w:{width:12},x:{width:7},y:{width:8,height:11},z:{width:7}},spacing:{char:1,word:4,line:5},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ    ","abcdefghij","klmnopqrst","uvwxyz"]},smallcaps:{id:"smallcaps",cellsize:{width:5,height:5},charsize:{width:5,height:5},exceptions:{1:{width:3},",":{width:1},".":{width:1},"!":{width:1},"/":{width:3}},spacing:{char:1,word:3,line:2},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.!/"]},smallcapsBold:{id:"smallcaps-bold",cellsize:{width:7,height:5},charsize:{width:6,height:5},exceptions:{1:{width:4},M:{width:7},W:{width:7},",":{width:2},".":{width:2},"-":{width:4},"/":{width:3}},spacing:{char:1,word:4,line:2},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.-/"]},smallcapsRadiant:{id:"smallcaps-radiant",cellsize:{width:8,height:7},charsize:{width:8,height:7},exceptions:{1:{width:6},"/":{width:5}},spacing:{char:-1,word:4,line:2},layout:["0123456789","/         "]},six:{id:"six",cellsize:{width:5,height:6},charsize:{width:5,height:6},exceptions:{1:{width:3},"/":{width:3}},spacing:{char:1,word:3,line:2},layout:["0123456789","/"]},numbers:{id:"numbers",cellsize:{width:6,height:6},charsize:{width:6,height:6},exceptions:{1:{width:4},"/":{width:3}},spacing:{char:1,word:3,line:2},layout:["0123456789","/"]}};function extract(image,x,y,width,height){var canvas=document.createElement("canvas"),context=canvas.getContext("2d");return canvas.width=width,canvas.height=height,context.drawImage(image,-x,-y),canvas}function fromCanvas(image){return image.getContext("2d").getImageData(0,0,image.width,image.height)}function toCanvas(data){var canvas=document.createElement("canvas"),context=canvas.getContext("2d");return canvas.width=data.width,canvas.height=data.height,context.putImageData(data,0,0),canvas}function replace(image,oldColor,newColor){oldColor[3]||((oldColor=oldColor.slice())[3]=255),newColor[3]||((newColor=newColor.slice())[3]=255);for(var i=0;i<image.data.length;i+=4){for(var c=0;c<4&&image.data[i+c]===oldColor[c];c++);if(4===c)for(c=0;c<4;c++)image.data[i+c]=newColor[c]}return image}var matrix=[["white","opal","pink","opalhp","orangehp"],["black","blue","red","redhp","yellowhp"],["silver","navy","maroon","beige","greenhp"],["gray",null,"purple","taupe","cyanhp"],["coal","yellow","gold","brass","bluehp"],["jet","cream","sage","brown","indigohp"]],mappings={factions:{player:{light:"opal",normal:"blue",dark:"navy"},enemy:{light:"pink",normal:"red",dark:"purple"}}};function match(image){for(var palette={},data=function(image){var canvas=document.createElement("canvas"),context=image.getContext("2d");return canvas.width=image.width,canvas.height=image.height,context.drawImage(canvas,0,0),context.getImageData(0,0,image.width,image.height)}(image),_y2=0;_y2<matrix.length;_y2++)for(var _x2=0;_x2<matrix[_y2].length;_x2++){var colorname=matrix[_y2][_x2];colorname&&(palette[colorname]=function(image,i,y){return i=4*(y*image.width+i),[image.data[i],image.data[1+i],image.data[2+i],image.data[3+i]]}(data,_x2,_y2))}return function assign(obj,mappings){for(var n in mappings)"object"===_typeof(mappings[n])?(obj[n]={},assign(obj[n],mappings[n])):obj[n]=palette[mappings[n]]}(palette,mappings),palette}function create(width,height){var canvas=document.createElement("canvas");return canvas.width=width,canvas.height=height,canvas.getContext("2d")}function copy(canvas){var result=create(canvas.width,canvas.height);return result.drawImage(canvas,0,0),result}function replace$1(canvas,oldColor,newColor){return toCanvas(replace(fromCanvas(canvas),oldColor,newColor))}function recolor$1(canvas,newColor){return toCanvas(function(image,newColor){newColor[3]||((newColor=newColor.slice())[3]=255);for(var i=0;i<image.data.length;i+=4)if(0!==image.data[i+3])for(var c=0;c<4;c++)image.data[i+c]=newColor[c];return image}(fromCanvas(canvas),newColor))}function disasmSelect(images,palette){var faction,select={glow:{},ring:{},cursor:{},arrows:{}};for(faction in palette.factions){var cursor=palette.factions[faction];select.glow[faction]=images["select-glow"];var cursorbase=images["select-ring"],ringshadow=replace$1(cursorbase,palette.white,cursor.light),cursorshadow=create(cursorbase.width,cursorbase.height+1);cursorshadow.drawImage(ringshadow,0,1),cursorshadow.drawImage(cursorbase,0,0),select.ring[faction]=cursorshadow.canvas;cursorbase=images["select-cursor"],cursorshadow=replace$1(cursorbase,palette.white,cursor.light),cursor=create(cursorbase.width+1,cursorbase.height+1);cursor.drawImage(cursorshadow,1,1),cursor.drawImage(cursorbase,0,0),select.cursor[faction]=cursor.canvas,select.arrows[faction]=function(images,palette,sheet){return sheet=palette.factions[sheet],{left:extract(sheet=replace$1(images["select-arrows"],palette.black,sheet.light),0,0,16,16),right:extract(sheet,16,0,16,16),up:extract(sheet,32,0,16,16),down:extract(sheet,48,0,16,16),leftStub:extract(sheet,0,16,16,16),rightStub:extract(sheet,16,16,16,16),upStub:extract(sheet,32,16,16,16),downStub:extract(sheet,48,16,16,16),upleft:extract(sheet,0,32,16,16),upright:extract(sheet,16,32,16,16),downleft:extract(sheet,32,32,16,16),downright:extract(sheet,48,32,16,16),leftright:extract(sheet,0,48,16,16),updown:extract(sheet,16,48,16,16)}}(images,palette,faction)}return select}function rgb(r,g,b){return"rgb("+r+", "+g+", "+b+")"}function replaceColor(canvas,oldColors,newColors){for(var context=canvas.getContext("2d"),image=context.getImageData(0,0,canvas.width,canvas.height),i=0;i<image.data.length;i+=4){for(var o=0;o<oldColors.length;o++){for(var c=0;c<4&&image.data[i+c]===oldColors[o][c];c++);if(4===c)break}if(o<oldColors.length)for(c=0;c<4;c++)image.data[i+c]=newColors[o][c]}return context.putImageData(image,0,0),canvas}function disasmBars(image,palette){var bars={small:function(image,newColors){newColors=[newColors.cream,newColors.brass,newColors.coal,newColors.jet];return replaceColor(image,[[255,255,255,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],newColors),image}(extract(image,0,0,51,5),palette)};return replaceColor(image,[[255,255,255,255],[204,204,204,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],[palette.white,palette.opal,palette.gray,palette.coal,palette.jet]),bars.left=extract(image,0,5,68,11),bars.right=extract(image,0,16,68,11),bars}function makeCharmap(image,font,color,stroke){if(!image)throw new Error("No image found for font "+font.id+". Try rebuilding your spritesheet.");var charmap={},cols=image.width/font.cellsize.width,rows=image.height/font.cellsize.height;color&&(image=replace$1(image,[255,255,255,255],color));for(var row=0;row<rows;row++)for(var col=0;col<cols;col++){var char=font.layout[row][col];if(char){var axis,size={width:font.charsize.width,height:font.charsize.height},offsets=font.exceptions[char];for(axis in offsets)size[axis]=offsets[axis];var base=extract(image,col*font.cellsize.width,row*font.cellsize.height,size.width,size.height);charmap[char]=stroke?function(image,color){for(var result=create(image.width+2,image.height+2),base=recolor$1(image,color),_y3=0;_y3<3;_y3++)for(var _x3=0;_x3<3;_x3++)1===_x3&&1===_y3||result.drawImage(base,_x3,_y3);return result.drawImage(image,1,1),result.canvas}(base,stroke):base}}return charmap}function disasmFonts(images,fonts,palette){var fontname,result={};for(fontname in fonts){var font=fonts[fontname],image=images["font-"+font.id];result[fontname]=function(image,data,palette){var charmap=makeCharmap(image,data);return{image:image,data:data,cache:_defineProperty({default:charmap},palette.white,charmap)}}(image,font,palette)}return result}function normalize(enemyColors){var image,newColors,tags,oldColors,yellows,playerColors,images=function disasm(sheet,srcmap){var id,_x,_y,w,h,sprites={};for(id in srcmap)Array.isArray(srcmap[id])?(_x=(h=_slicedToArray(srcmap[id],4))[0],_y=h[1],w=h[2],h=h[3],sprites[id]=extract(sheet,_x,_y,w,h)):sprites[id]=disasm(sheet,srcmap[id]);return sprites}(enemyColors,srcmap),palette=match(images.palette),icons=function(images){var name,icons={small:{},types:{axe:"fighter",bow:"archer",dagger:"thief",hat:"mage",shield:"knight",sword:"soldier"},fire:images["icon-fire"],ice:images["icon-ice"],volt:images["icon-volt"],plant:images["icon-plant"],holy:images["icon-holy"],dark:images["icon-dark"]};for(name in icons.types){var type=icons.types[name];icons.small[name]=images["icon6-"+name],icons.small[type]=images["icon6-"+name],icons[name]=images["icon8-"+name],icons[type]=images["icon8-"+name]}return icons}(images),select=disasmSelect(images,palette);return{icons:icons,palette:palette,select:select,Arrow:function(path,faction){return function(sprites,path){for(var arrow=[],stubdir=null,i=0;i<path.length;i++){var cell=path[i],l=(cell.x,cell.y,!1),r=!1,u=!1,d=!1,sprite=path[i-1];sprite&&(1===(dx=cell.x-sprite.x)?l=!0:-1===dx&&(r=!0),1===(dy=cell.y-sprite.y)?u=!0:-1===dy&&(d=!0));var dx,dy,sprite=path[i+1];sprite&&(-1===(dx=sprite.x-cell.x)?l=!0:1===dx&&(r=!0),-1===(dy=sprite.y-cell.y)?u=!0:1===dy&&(d=!0)),(l||r||u||d)&&(sprite=null,!i&&l?stubdir="left":!i&&r?stubdir="right":!i&&u?stubdir="up":!i&&d?stubdir="down":u&&l?sprite="upleft":u&&r?sprite="upright":d&&l?sprite="downleft":d&&r?sprite="downright":1===i&&"left"===stubdir&&2<path.length?sprite="leftStub":1===i&&"right"===stubdir&&2<path.length?sprite="rightStub":1===i&&"up"===stubdir&&2<path.length?sprite="upStub":1===i&&"down"===stubdir&&2<path.length?sprite="downStub":l&&r?sprite="leftright":u&&d?sprite="updown":l?sprite="left":r?sprite="right":u?sprite="up":d&&(sprite="down"),sprite&&(sprite=sprites[sprite],arrow.push({image:sprite,x:cell.x*sprite.width,y:cell.y*sprite.height})))}return arrow}(select.arrows[faction],path)},squares:function(){var move=create(16,16);move.globalAlpha=.25,move.fillStyle="blue",move.fillRect(0,0,15,15);var attack=create(16,16);return attack.globalAlpha=.25,attack.fillStyle="red",attack.fillRect(0,0,15,15),{move:move.canvas,attack:attack.canvas}}(),vs:function(image,palette){return replaceColor(image,[[255,255,255,255],[204,204,204,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],[palette.white,palette.opal,palette.gray,palette.coal,palette.jet]),image}(images.vs,palette),tag:(image=images.tag,tags={},oldColors=[[255,255,255,255],[204,204,204,255],[153,153,153,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],yellows=[(newColors=palette).yellow,newColors.gold,newColors.brass],playerColors=[newColors.opal,newColors.coal,newColors.jet],enemyColors=[newColors.pink,newColors.maroon,newColors.jet],newColors=yellows.concat(playerColors),replaceColor(image,oldColors,newColors),tags.player={start:extract(image,0,0,2,12),end:extract(image,2,0,3,12),palette:playerColors},oldColors=newColors,newColors=yellows.concat(enemyColors),replaceColor(image=copy(image).canvas,oldColors,newColors),tags.enemy={start:extract(image,0,0,2,12),end:extract(image,2,0,3,12),palette:enemyColors},tags),bars:disasmBars(images.bars,palette),labels:function(image,palette){return replaceColor(image,[[255,255,255,255],[204,204,204,255],[153,153,153,255],[102,102,102,255]],[palette.yellow,palette.gold,palette.brass,palette.brown]),{hp:extract(image,0,0,13,9),ap:extract(image,0,9,13,9)}}(images.labels,palette),buttons:function(image){return{large:extract(image,0,0,24,24),small:extract(image,0,24,18,18),boot:extract(image,24,0,15,14),sword:extract(image,39,0,14,14),hourglass:extract(image,53,0,13,15),stats:extract(image,24,14,14,15),undo:extract(image,38,15,17,15),back:extract(image,55,15,14,13)}}(images.buttons),badges:function(image,palette){return replaceColor(image,[[255,255,255,255],[204,204,204,255],[102,102,102,255],[0,0,0,255]],[palette.white,palette.opal,palette.coal,palette.jet]),{sword:extract(image,0,0,8,8),lance:extract(image,8,0,8,8),axe:extract(image,16,0,8,8),bow:extract(image,24,0,8,8),shield:extract(image,0,8,8,8),target:extract(image,8,8,8,8),wing:extract(image,16,8,8,8),dagger:extract(image,24,8,8,8),fire:extract(image,0,16,8,8),ice:extract(image,8,16,8,8),volt:extract(image,16,16,8,8),dark:extract(image,24,16,8,8)}}(images.badges,palette),pieces:function(base,icons,palette){var faction,pieces={done:{},shadow:recolor$1(base,[0,0,0,191])};for(faction in palette.factions){pieces[faction]={},pieces.done[faction]={};var iconname,subpal=palette.factions[faction];for(iconname in icons.types){var unittype=icons.types[iconname],done=icons.small[iconname],_piece=Piece(base,done,subpal),done=Piece(base,done,{light:subpal.normal,normal:subpal.dark,dark:palette.black});pieces[faction][unittype]=_piece,pieces.done[faction][unittype]=done}}return pieces;function Piece(piece,icon,colors){var template=recolor$1(piece,colors.normal),tmp=colors.dark!==palette.black?recolor$1(piece,colors.dark):piece,piece=create(piece.width,piece.height+2);piece.drawImage(tmp,0,2),piece.drawImage(template,0,0);tmp=create(8,8),template=icon.getContext("2d").getImageData(0,0,icon.width,icon.height);return replace(template,palette.white,colors.light),tmp.putImageData(template,0,0),piece.drawImage(tmp.canvas,4,5),tmp=create(8,8),replace(template=icon.getContext("2d").getImageData(0,0,icon.width,icon.height),palette.white,colors.dark),tmp.putImageData(template,0,0),piece.drawImage(tmp.canvas,4,4),piece.canvas}}(images.piece,icons,palette),fonts:disasmFonts(images,fonts,palette)}}function equals(a,b){return a.x===b.x&&a.y===b.y}function distance(a,b){return Math.abs(b.x-a.x)+Math.abs(b.y-a.y)}function neighbors(cell){return[{x:cell.x-1,y:cell.y},{x:cell.x+1,y:cell.y},{x:cell.x,y:cell.y-1},{x:cell.x,y:cell.y+1}]}function neighborhood(cell,radius){for(var queue=[{steps:0,cell:cell}],cells=[];queue.length;)for(var node=queue.shift(),adj=neighbors(node.cell),i=0;i<adj.length;i++){var neighbor=adj[i];if(!equals(cell,neighbor)){for(var j=0;j<cells.length;j++){if(equals(neighbor,cells[j]))break}j<cells.length||(cells.push(neighbor),node.steps+1<radius&&queue.push({steps:node.steps+1,cell:neighbor}))}}return cells}function contains(map,cell){return 0<=cell.x&&0<=cell.y&&cell.x<map.width&&cell.y<map.height}function walkable(map,cell){return contains(map,cell)}function unitAt(map,cell){if(contains(map,cell)){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _iterator=map.units[Symbol.iterator]();!(_iteratorNormalCompletion=(unit=_iterator.next()).done);_iteratorNormalCompletion=!0){var unit=unit.value;if(equals(unit.cell,cell))return unit}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}function move(unit,dest,map){return walkable(map,unit.cell)&&(unit.cell=dest,1)}function allied(a,b){return a.faction===b.faction}function mov(unit){return"knight"===unit.type?4:"thief"===unit.type?6:5}function rng(unit){return"mage"===unit.type||"archer"===unit.type?2:1}function dmg(unit,dmg){if(hit(unit,dmg)<=0)return null;dmg=unit.stats.atk-dmg.stats.def;return dmg<0&&(dmg=0),dmg}function hit(unit,target){return distance(unit.cell,target.cell)>rng(unit)?null:unit.stats.hit-target.stats.spd}function endTurn(index,game){var pending=game.phase.pending,index=pending.indexOf(index);return-1!==index&&(pending.splice(index,1),pending.length||function nextPhase(game){var map=game.map,phase=game.phase;"player"===phase.faction?phase.faction="enemy":"enemy"===phase.faction&&(phase.faction="player");phase.pending=map.units.filter(function(unit){return unit.faction===phase.faction});phase.pending.length||nextPhase(game)}(game),1)}function strify(cell){return cell.x+","+cell.y}function pathfind(start,goal,opts){var path=[],open=[start],opened={},closed={},parent={},g={},f={};if(opts.width&&opts.height)for(var y=0;y<opts.height;y++)for(var x=0;x<opts.width;x++)g[x+","+y]=1/0,f[x+","+y]=1/0;for(g[strify(start)]=0,f[strify(start)]=distance(start,goal);open.length;){for(var cell,best={score:1/0,index:-1,cell:null},i=0;i<open.length;i++){(score=f[strify(cell=open[i])])<best.score&&(best.score=score,best.index=i,best.cell=cell)}if(equals(cell=best.cell,goal)){for(;!equals(cell,start);)path.unshift(cell),cell=parent[strify(cell)];return path.unshift(cell),path}open.splice(best.index,1),opened[strify(cell)]=!1,closed[strify(cell)]=!0;for(var adj=neighbors(cell),i=0;i<adj.length;i++){var score,neighbor=adj[i];if(!closed[strify(neighbor)]&&!(opts&&opts.width&&opts.height&&(neighbor.x<0||neighbor.y<0||neighbor.x>=opts.width||neighbor.y>=opts.height))){if(opts&&opts.blacklist){for(var j=0;j<opts.blacklist.length;j++){if(equals(opts.blacklist[j],neighbor))break}if(j<opts.blacklist.length)continue}opened[strify(neighbor)]||(opened[strify(neighbor)]=!0,open.push(neighbor)),(score=g[strify(cell)]+1)>=g[strify(neighbor)]||(parent[strify(neighbor)]=cell,g[strify(neighbor)]=score,f[strify(neighbor)]=score+distance(neighbor,goal))}}}}function drawShadow(image,shadow){var result=create(image.width+1,image.height+1),shadow=recolor$1(image,shadow);return result.drawImage(shadow,0,1),result.drawImage(shadow,1,0),result.drawImage(shadow,1,1),result.drawImage(image,0,0),result.canvas}function renderText(content,style,_didIteratorError6){var _iteratorError6=style.color?style.stroke?style.color+"+"+style.stroke:style.color:"default",font=style.font;if(!font)throw new Error("Attempting to render an unregistered font. Is your font exported by fonts/index.js?");font.cache[_iteratorError6]||(font.cache[_iteratorError6]=makeCharmap(font.image,font.data,style.color,style.stroke));var cached=font.cache[_iteratorError6];content=content.toString(),_didIteratorError6=_didIteratorError6||function(content,font,stroked){var width=0,_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _iterator5=content[Symbol.iterator]();!(_iteratorNormalCompletion5=(image=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var cache,image,char=image.value;" "!==char?(image=(image=(cache=font.cache.default)[char])||cache[char.toUpperCase()])&&(width+=image.width+font.data.spacing.char):width+=font.data.spacing.word}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return width&&(width-=font.data.spacing.char),stroked&&(width+=2),width}(content,font,style.stroke);_iteratorError6=font.data.cellsize.height;style.stroke&&(_iteratorError6+=2);var text=create(_didIteratorError6,_iteratorError6),x=0,kerning=font.data.spacing.char;style.stroke&&(kerning-=2);var _iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _iterator6=content[Symbol.iterator]();!(_iteratorNormalCompletion6=(image=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var image,char=image.value;" "!==char?(image=(image=cached[char])||cached[char.toUpperCase()])&&(text.drawImage(image,x,0),x+=image.width+kerning):x+=font.data.spacing.word}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}return style.shadow?drawShadow(text.canvas,style.shadow):text.canvas}function renderNameTag(name,tag,x){var fonts=x.fonts,text=x.palette,text=renderText(name,{font:fonts.standard,shadow:text.jet}),tag=function(width,height,faction,sprites){var palette=sprites.tag[faction].palette,tag=create(width+1,height+1);return tag.fillStyle=rgb.apply(void 0,_toConsumableArray(palette[0])),tag.fillRect(2,0,width-2,1),tag.fillStyle=rgb.apply(void 0,_toConsumableArray(palette[1])),tag.fillRect(2,1,width-2,height-1),tag.fillStyle=rgb.apply(void 0,_toConsumableArray(palette[2])),tag.fillRect(2,height,width-2,1),tag.drawImage(sprites.tag[faction].start,0,0),tag.drawImage(sprites.tag[faction].end,width-2,0),tag.canvas}(52,2+text.height-3+2,tag,x).getContext("2d"),x=Math.ceil(26-(text.width-1)/2);return tag.drawImage(text,x,2),tag.canvas}function getGradient(hp,end,palette,reverse){var start="player"===end?palette.opalhp:palette.redhp,end=palette.redhp;return 15===hp?end=palette.indigohp:14<=hp?end=palette.bluehp:12<=hp?end=palette.cyanhp:10<=hp?end=palette.greenhp:8<=hp?end=palette.yellowhp:3<=hp&&(end=palette.orangehp),reverse?[end,start]:[start,end]}function getBadge(unit,badges){var badge=badges.sword;return"fighter"===unit.type?badge=badges.axe:"knight"===unit.type?badge=badges.lance:"thief"===unit.type?badge=badges.dagger:"archer"===unit.type?badge=badges.bow:"mage"===unit.type&&badges[unit.stats.element]&&(badge=badges[unit.stats.element]),badge}function renderUnitPreview(unit,sprites){var fonts=sprites.fonts,palette=sprites.palette,tag=renderNameTag(unit.name,unit.faction,sprites),x=function(){var content=create(68,29),label=sprites.labels.hp,shadowed=renderText(unit.stats.hp+"/"+unit.stats.hp,{font:fonts.smallcapsRadiant}),health=create(48,3),labelshadow=getGradient(unit.stats.hp,unit.faction,palette),shadow=_slicedToArray(labelshadow,2),start=shadow[0],labelshadow=shadow[1],shadow=health.createLinearGradient(0,1,health.canvas.width-2,1);shadow.addColorStop(0,rgb.apply(void 0,_toConsumableArray(start))),shadow.addColorStop(1,rgb.apply(void 0,_toConsumableArray(labelshadow))),health.fillStyle=shadow,health.fillRect(2,0,health.canvas.width-2,1),health.fillRect(1,1,health.canvas.width-2,1),health.fillRect(0,2,health.canvas.width-2,1),content.drawImage(label,2,0);labelshadow=recolor$1(content.canvas,palette.taupe);content.drawImage(shadowed,2+label.width+4,2);shadow=recolor$1(content.canvas,palette.taupe);content.drawImage(sprites.bars.small,2+label.width,0),content.drawImage(shadow,1,1),content.drawImage(labelshadow,1,1),content.drawImage(health.canvas,2+label.width+1,1),content.drawImage(label,2,0),content.drawImage(shadowed,2+label.width+4,2);shadowed=function(value){var stats=create(value,11);stats.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.cream)),stats.fillRect(1,0,value-2,11),stats.fillRect(0,1,value,9);var shadowed=create(value-6,9),stat=unit.stats.atk,badge=getBadge(unit,sprites.badges),value=renderText(stat,{font:fonts.numbers,color:palette.jet});shadowed.drawImage(badge,0,0),shadowed.drawImage(value,0+badge.width+2,1),stat=unit.stats.hit,badge=sprites.badges.target,value=renderText(stat,{font:fonts.numbers,color:palette.jet}),shadowed.drawImage(badge,21,0),shadowed.drawImage(value,21+badge.width+2,1),stat=unit.stats.spd,badge=sprites.badges.wing,unit.stats.def>unit.stats.spd&&(stat=unit.stats.def,badge=sprites.badges.shield),value=renderText(stat,{font:fonts.numbers,color:palette.jet}),shadowed.drawImage(badge,42,0),shadowed.drawImage(value,42+badge.width+2,1);shadowed=drawShadow(shadowed.canvas,palette.sage);return stats.drawImage(shadowed,3,1),stats.canvas}(content.canvas.width-4);content.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.taupe)),content.fillRect(2,label.height+3,content.canvas.width-4,1);shadowed=drawShadow(shadowed,palette.sage);return content.drawImage(shadowed,2,label.height+6),content.canvas}(),shadow=function(width,height,box){var palette=box.palette;return(box=create(width+2,height+2)).fillStyle=rgb.apply(void 0,_toConsumableArray(palette.brown)),box.fillRect(0,1,width+2,height),box.fillRect(1,0,width,height+2),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.taupe)),box.fillRect(0,1,width+1,height-1),box.fillRect(1,0,width-1,height+1),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.beige)),box.fillRect(0,1,width,height-2),box.fillRect(1,0,width-2,height),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.taupe)),box.fillRect(2,1,width-4,height-2),box.fillRect(1,2,width-2,height-4),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.beige)),box.fillRect(2,2,width-4,height-4),box.canvas}(76,x.height+8,sprites).getContext("2d"),preview=create(shadow.canvas.width,shadow.canvas.height+9);shadow.drawImage(x,4,6),preview.drawImage(shadow.canvas,0,9);x=Math.ceil(37-(tag.width-1)/2),shadow=recolor$1(tag,palette.taupe);return preview.drawImage(shadow,x,1),preview.drawImage(tag,x,0),preview.canvas}var maxwidth=55;function renderPanel(text,atkVal,val2,panel){var ctrVal=panel.palette,fonts=panel.fonts,panel=renderBase(text,panel).getContext("2d"),ctrVal={font:fonts.smallcapsBold,color:ctrVal.jet,shadow:ctrVal.sage},atkVal=renderText(atkVal,ctrVal),ctrVal=renderText(val2,ctrVal);return panel.drawImage(atkVal,8-Math.floor(atkVal.width/2),3),panel.drawImage(ctrVal,55-Math.floor(ctrVal.width/2),3),panel.canvas}function renderBase(text,base){var palette=base.palette,label=base.fonts,base=create(64,12),label=renderText(text,{font:label.smallcapsBold,shadow:palette.jet});return base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.sage)),base.fillRect(1,0,62,12),base.fillRect(0,1,64,10),base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.cream)),base.fillRect(1,0,61,11),base.fillRect(0,1,63,9),base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.jet)),base.fillRect(17,0,30,12),base.fillRect(16,1,32,10),base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.brown)),base.fillRect(17,0,29,11),base.fillRect(16,1,31,9),base.drawImage(label,21,3),base.canvas}var rangeExpand=Object.freeze({__proto__:null,create:function(range){return{type:"RangeExpand",done:!1,time:0,src:range,range:{center:range.center,radius:range.radius,squares:[]}}},update:function(anim){if(!anim.done){var _iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _iterator7=anim.src.squares[Symbol.iterator]();!(_iteratorNormalCompletion7=(square=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var square=square.value;distance(anim.range.center,square.cell)===anim.time&&anim.range.squares.push(square)}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}anim.time++===anim.range.radius&&(anim.done=!0)}}});var rangeShrink=Object.freeze({__proto__:null,create:function(range){return{type:"RangeShrink",done:!1,range:range}},update:function(anim){if(!anim.done){for(var i=0;i<anim.range.squares.length;i++){var square=anim.range.squares[i];distance(anim.range.center,square.cell)===anim.range.radius&&anim.range.squares.splice(i--,1)}anim.range.radius--<0&&(anim.done=!0)}}});function easeOut(t){return-t*(t-2)}var previewEnter=Object.freeze({__proto__:null,create:function(){return{type:"PreviewEnter",blocking:!0,done:!1,x:0,time:0}},update:function(anim){var t;anim.done||(t=anim.time/10,anim.x=easeOut(t),10==anim.time++&&(anim.done=!0))}});var previewExit=Object.freeze({__proto__:null,create:function(x,id){return{type:"PreviewExit",blocking:!0,done:!1,x:x||1,id:id}},update:function(anim){anim.done||(anim.x-=.2,anim.x<0&&(anim.x=0,anim.done=!0))}});var pieceLift=Object.freeze({__proto__:null,height:4,create:function(){return{type:"PieceLift",done:!1,y:0,time:0,floating:!1}},update:function(anim){var t;anim.done||(anim.time++,anim.floating?(t=anim.time%120/120,anim.y=4+Math.sin(2*Math.PI*t)):4==++anim.y&&(anim.floating=!0))}});var pieceDrop=Object.freeze({__proto__:null,create:function(y){return{type:"PieceDrop",done:!1,y:y||4}},update:function(anim){anim.done||--anim.y<=0&&(anim.y=0,anim.done=!0)}});var lerp_1=function(v0,v1,t){return v0*(1-t)+v1*t};var pieceMove=Object.freeze({__proto__:null,create:function(path){return{type:"PieceMove",blocking:!0,done:!1,time:0,path:path,cell:{x:path[0].x,y:path[0].y}}},update:function(anim){if(anim.done)return!1;var next=Math.floor(anim.time/4),t=anim.time%4/4,cell=anim.path[next];return(next=anim.path[next+1])?(anim.cell.x=lerp_1(cell.x,next.x,t),anim.cell.y=lerp_1(cell.y,next.y,t)):(anim.cell.x=cell.x,anim.cell.y=cell.y,anim.done=!0),anim.time++,!0}});var easeOut$1=Object.freeze({__proto__:null,create:function(duration,delay){return{type:"EaseOut",done:!1,duration:duration,delay:delay||0,x:0,time:0}},update:function(anim){var t;anim.done||(t=Math.max(0,anim.time-anim.delay)/anim.duration,anim.x=easeOut(t),anim.time++,anim.time-anim.delay>=anim.duration&&(anim.done=!0))}});function getAugmentedNamespace(n){if(n.__esModule)return n;var a=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(k){var d=Object.getOwnPropertyDescriptor(n,k);Object.defineProperty(a,k,d.get?d:{enumerable:!0,get:function(){return n[k]}})}),a}var anims={RangeExpand:getAugmentedNamespace(rangeExpand),RangeShrink:getAugmentedNamespace(rangeShrink),PreviewEnter:getAugmentedNamespace(previewEnter),PreviewExit:getAugmentedNamespace(previewExit),PieceLift:getAugmentedNamespace(pieceLift),PieceDrop:getAugmentedNamespace(pieceDrop),PieceMove:getAugmentedNamespace(pieceMove),EaseOut:getAugmentedNamespace(easeOut$1)},tilesize=16;function init(view,game){var state=view.state,cache=view.cache,sprites=view.sprites,camera=state.camera,pointer=state.pointer,anims$1=state.anims,map=game.map;view.game=game,view.cache.map=function(map,tilesize,palette){var canvas=document.createElement("canvas"),context=canvas.getContext("2d");canvas.width=map.width*tilesize,canvas.height=map.height*tilesize,context.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.coal)),context.fillRect(0,0,canvas.width,canvas.height),context.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.jet));for(var i=0;i<map.height;i++)for(var _x5,_y5,j=0;j<map.width;j++){(j+i)%2&&(_x5=j*tilesize,_y5=i*tilesize,context.fillRect(_x5,_y5,tilesize,tilesize))}return canvas}(map,tilesize,sprites.palette);var device=null,events={resize:function(){var scaleX,canvas;scaleX=Math.max(1,Math.floor(window.innerWidth/view.native.width)),canvas=Math.max(1,Math.floor(window.innerHeight/view.native.height)),view.scale=Math.min(scaleX,canvas),view.width=Math.ceil(window.innerWidth/view.scale),view.height=Math.ceil(window.innerHeight/view.scale),(canvas=view.element).width=view.width,canvas.height=view.height,canvas.style.transform="scale("+view.scale+")",state.dirty=!0},press:function(unit){if(device=device||function(event){var device="desktop";event.touches?(device="mobile",window.removeEventListener("mousedown",events.press),window.removeEventListener("mousemove",events.move),window.removeEventListener("mouseup",events.release)):(window.removeEventListener("touchstart",events.press),window.removeEventListener("touchmove",events.move),window.removeEventListener("touchend",events.release));return device}(unit),pointer.pressed)return!1;if(anims$1.find(function(anim){return anim.blocking}))return!1;if(pointer.time=state.time,pointer.pos=getPosition(unit),!pointer.pos)return!1;pointer.clicking=!0,pointer.pressed=pointer.pos;var cursor=snapToGrid(pointer.pos);if(pointer.unit=unitAt(map,cursor),"select"!==state.mode)return!0;pointer.offset={x:camera.pos.x*view.scale,y:camera.pos.y*view.scale},state.select&&(unit=state.select.unit,game.phase.pending.includes(unit)&&actions.hover(cursor)&&(pointer.select=!0))},move:function(event){var cursor;pointer.pos=getPosition(event),pointer.pos&&pointer.pressed&&(pointer.clicking&&(cursor=pointer.pos,4<distance(pointer.pressed,cursor)&&(pointer.clicking=!1,pointer.unit=!1)),anims$1.find(function(anim){return anim.blocking})||"select"!==state.mode||(pointer.select?(cursor=snapToGrid(pointer.pos),equals(pointer.select,cursor)||actions.hover(cursor)):actions.panCamera(camera,pointer)))},release:function(){if(!pointer.pressed)return!1;var cursor,unit,select,_unit,square;anims$1.find(function(anim){return anim.blocking})||("attack"===state.mode?(move(state.select.unit,state.select.src,map),cache.forecast=null,cache.range=null,state.mode="select",state.dirty=!0,state.select=null,state.target=null):(cursor=null,pointer.clicking&&(cursor=snapToGrid(pointer.pressed)),pointer.select&&(cursor=snapToGrid(pointer.pos)),cursor&&(unit=unitAt(map,cursor),state.select?(_unit=(select=state.select).unit,square=null,cache.range&&game.phase.pending.includes(_unit)&&(square=cache.range.squares.find(function(_ref2){return equals(_ref2.cell,cursor)})),square&&select.path?actions.move(_unit,cursor):pointer.clicking?actions.deselect():actions.unhover()):unit&&actions.select(unit))),pointer.clicking=!1,pointer.unit=null,pointer.select=!1,pointer.pressed=null)}},actions={select:function(unit){var lift=function(unit,map){var mov$1=mov(unit),rng$1=rng(unit),_iteratorError3=mov$1+rng$1,range={center:unit.cell,radius:_iteratorError3,squares:[]},queue=[{steps:0,cell:unit.cell}],edges=[];for(mov$1||(queue.length=0,edges.push(unit.cell));queue.length;){var node=queue.shift(),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=neighbors(node.cell)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)(function(neighbor){if(!walkable(map,neighbor,node.cell))return;if(range.squares.find(function(square){return"move"===square.type&&equals(neighbor,square.cell)}))return;var target=unitAt(map,neighbor);target?allied(unit,target)||range.squares.find(function(square){return"attack"===square.type&&equals(neighbor,square.cell)})||range.squares.push({type:"attack",cell:neighbor,target:target}):range.squares.push({type:"move",cell:neighbor}),node.steps<mov$1-1?target&&!allied(unit,target)||queue.push({steps:node.steps+1,cell:neighbor}):edges.push(neighbor)})(_step2.value)}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _iterator3=edges[Symbol.iterator]();!(_iteratorNormalCompletion3=(_iteratorError4=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var edge=_iteratorError4.value,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=neighborhood(edge,rng$1)[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)(function(_neighbor){if(!contains(map,_neighbor)||!walkable(map,_neighbor)||equals(unit.cell,_neighbor))return;var target=unitAt(map,_neighbor);if(!target||!allied(unit,target)){if(range.squares.find(function(square){return equals(_neighbor,square.cell)}))return;range.squares.push({type:"attack",cell:_neighbor,target:target})}})(_step4.value)}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return range}(unit,map),preview=renderUnitPreview(unit,sprites),expand=anims.RangeExpand.create(lift),enter=anims.PreviewEnter.create(),lift=anims.PieceLift.create();state.anims.push(expand,enter,lift),state.select={unit:unit,anim:lift,path:null,arrow:null,cursor:null,valid:!1},cache.range=expand.range,cache.playerview={image:preview,anim:enter},!pointer.select&&game.phase.pending.includes(unit)&&actions.centerCamera(unit.cell)},deselect:function(){if(!state.select)return!1;var exit,select=state.select;select.anim.done=!0,cache.range&&(exit=anims.RangeShrink.create(cache.range),state.anims.push(exit)),cache.playerview&&(exit=anims.PreviewExit.create(cache.playerview.anim.x,"playerview"),cache.playerview.anim.done=!0,cache.playerview.anim=exit,state.anims.push(exit)),cache.enemyview&&(drop=anims.PreviewExit.create(cache.enemyview.anim.x,"enemyview"),cache.enemyview.anim.done=!0,cache.enemyview.anim=drop,state.anims.push(drop),state.target=null);var drop=anims.PieceDrop.create(select.anim.y);state.anims.push(drop),select.anim=drop},hover:function(cell){var select=state.select,unit=select.unit;if(select.cursor&&equals(select.cursor.target,cell))return!1;var square=cache.range.squares.find(function(square){return equals(square.cell,cell)&&("move"===square.type||"attack"===square.type&&square.target)}),path=null;if(square){var preview,enter,_target=cell,opts={width:map.width,height:map.height,blacklist:map.units.filter(function(other){return!allied(unit,other)}).map(function(unit){return unit.cell})};if(square.target&&!cache.enemyview&&(preview=renderUnitPreview(length=square.target,sprites),enter=anims.PreviewEnter.create(),cache.enemyview={image:preview,unit:length,anim:enter},state.anims.push(enter),state.target=length),!cache.enemyview||square.target&&square.target===cache.enemyview.unit||(backtrack=anims.PreviewExit.create(cache.enemyview.anim.x,"enemyview"),cache.enemyview.anim.done=!0,cache.enemyview.anim=backtrack,state.anims.push(backtrack),state.target=null),square.target&&!select.path&&1===distance(unit.cell,_target))path=[unit.cell];else{var length=select.path?select.path[select.path.length-1]:unit.cell,backtrack=rng(unit);if("attack"===square.type&&(distance(length,cell)>backtrack?_target=neighborhood(cell,backtrack).filter(function(cell){return!map.units.find(function(unit){return equals(cell,unit.cell)})}).sort(function(a,b){return distance(a,unit.cell)-distance(b,unit.cell)})[0]:select.path||(path=[unit.cell])),!path&&_target&&select.path){var cached=select.path,length=cached[cached.length-1];if("attack"!==square.type||distance(length,cell)>backtrack){for(var addendum=pathfind(length,_target,opts),i=addendum.length;1<=--i;){for(var j=0;j<cached.length;j++)if(equals(addendum[i],cached[j])){path=cached.slice(0,j).concat(addendum.slice(i));break}if(path)break}path||(backtrack=cached.find(function(cell){return equals(cell,_target)}),length=cached.length+addendum.length-2,backtrack?path=cached.slice(0,cached.indexOf(backtrack)+1):length<=mov(unit)&&(path=cached.concat(addendum.slice(1))))}else path=cached}}if(path=path||pathfind(unit.cell,_target,opts))return select.cursor?select.cursor.target=cell:select.cursor={pos:{x:cell.x*tilesize,y:cell.y*tilesize},target:cell},select.arrow=sprites.Arrow(path,unit.faction),select.path=path,select.valid=!0}return path?void 0:(select.cursor&&(select.cursor=null),select.valid=!1)},unhover:function(){var select=state.select;select.cursor=null,select.arrow=null,select.path=null,select.valid=!1},move:function(unit,cursor){if(!state.select)return!1;var _move,select=state.select;cache.range&&(_move=anims.RangeShrink.create(cache.range),state.anims.push(_move)),select.path&&(_move=anims.PieceMove.create(select.path),select.anim.done=!0,select.anim=_move,state.anims.push(_move)),state.select.src=state.select.unit.cell,state.select.dest=select.path[select.path.length-1],pointer.clicking?camera.follow=!0:actions.centerCamera(cursor)},panCamera:function(camera,bottom){camera.target.x=(bottom.pos.x-bottom.pressed.x+bottom.offset.x)/view.scale,camera.target.y=(bottom.pos.y-bottom.pressed.y+bottom.offset.y)/view.scale;var left=view.width/2,right=-view.width/2,top=view.height/2,bottom=-view.height/2;camera.target.x>left?camera.target.x=left:camera.target.x<right&&(camera.target.x=right),camera.target.y>top?camera.target.y=top:camera.target.y<bottom&&(camera.target.y=bottom)},centerCamera:function(cell){camera.focus=cell,camera.target.x=cache.map.width/2-(cell.x+.5)*tilesize,camera.target.y=cache.map.height/2-(cell.y+.5)*tilesize}};function getPosition(y){var x=y.pageX||y.touches&&y.touches[0].pageX,y=y.pageY||y.touches&&y.touches[0].pageY;return void 0===x||void 0===y?null:{x:x,y:y}}function snapToGrid(realpos_y){var gridpos_y=game.map,gridpos_x=(realpos_y.x-window.innerWidth/2)/view.scale,realpos_y=(realpos_y.y-window.innerHeight/2)/view.scale,gridpos_x=gridpos_x+gridpos_y.width*tilesize/2-camera.pos.x,gridpos_y=realpos_y+gridpos_y.height*tilesize/2-camera.pos.y;return{x:Math.floor(gridpos_x/tilesize),y:Math.floor(gridpos_y/tilesize)}}events.resize(),window.addEventListener("resize",events.resize),window.addEventListener("mousedown",events.press),window.addEventListener("mousemove",events.move),window.addEventListener("mouseup",events.release),window.addEventListener("touchstart",events.press),window.addEventListener("touchmove",events.move),window.addEventListener("touchend",events.release),requestAnimationFrame(function update(){var cursor;state.time++,state.dirty&&(state.dirty=!1,function(view){var sprites=view.sprites,state=(sprites.palette,view.state),cache=view.cache,_sprite=view.element,layers=view.layers,game=view.game,context=_sprite.getContext("2d");context.fillStyle="black",context.fillRect(0,0,_sprite.width,_sprite.height),state.camera;var name,pointer=state.pointer,select=state.select,origin=function(view){return{x:view.width/2-view.cache.map.width/2+view.state.camera.pos.x,y:view.height/2-view.cache.map.width/2+view.state.camera.pos.y}}(view);for(name in layers)layers[name].length=0;if(layers.map.push({image:cache.map,x:origin.x,y:origin.y}),cache.range){var _iteratorNormalCompletion8=!0,_x7=!1,_y7=void 0;try{for(var _iterator8=cache.range.squares[Symbol.iterator]();!(_iteratorNormalCompletion8=(_x6=_iterator8.next()).done);_iteratorNormalCompletion8=!0){var _y6=_x6.value,sprite=sprites.squares[_y6.type],_x6=origin.x+_y6.cell.x*tilesize,_y6=origin.y+_y6.cell.y*tilesize;layers.range.push({image:sprite,x:_x6,y:_y6})}}catch(err){_x7=!0,_y7=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_x7)throw _y7}}}if(select&&select.cursor&&(!select.anim||select.anim&&"PieceMove"!==select.anim.type)&&select.valid&&!equals(select.cursor.target,select.unit.cell)&&contains(game.map,select.cursor.target)&&(_sprite=sprites.select.cursor[game.phase.faction],_x7=origin.x+select.cursor.pos.x-1,_y7=origin.y+select.cursor.pos.y-1,layers.selection.push({image:_sprite,x:_x7,y:_y7})),select&&select.path&&select.anim&&("PieceMove"!==select.anim.type||state.time%2)){var _iteratorNormalCompletion9=!0,_didIteratorError10=!1,_image=void 0;try{for(var _iterator9=select.arrow[Symbol.iterator]();!(_iteratorNormalCompletion9=(_x8=_iterator9.next()).done);_iteratorNormalCompletion9=!0){var _y8=_x8.value,image=_y8.image,_x8=origin.x+_y8.x,_y8=origin.y+_y8.y;layers.arrows.push({image:image,x:_x8,y:_y8})}}catch(err){_didIteratorError10=!0,_image=err}finally{try{!_iteratorNormalCompletion9&&_iterator9.return&&_iterator9.return()}finally{if(_didIteratorError10)throw _image}}}var layername,preview,_x11,_y11,_iteratorNormalCompletion10=!0,_didIteratorError10=!1,_image=void 0;try{for(var _iterator10=game.map.units[Symbol.iterator]();!(_iteratorNormalCompletion10=(_y9=_iterator10.next()).done);_iteratorNormalCompletion10=!0){var anim,ring=_y9.value,_sprite2=sprites.pieces[ring.faction][ring.type],z=ring.cell,_x9=origin.x+z.x*tilesize,_y9=origin.y+z.y*tilesize,z=0,layer=null;game.phase.faction===ring.faction&&(game.phase.pending.includes(ring)?select&&select.unit===ring||(anim=sprites.select.glow[ring.faction],layers.pieces.push({image:anim,x:_x9,y:_y9-2,z:z})):_sprite2=sprites.pieces.done[ring.faction][ring.type]),layer=select&&select.unit===ring?((anim=select.anim)?(("PieceMove"!==anim.type||state.time%2)&&(ring=sprites.select.ring[ring.faction],layers.markers.push({image:ring,x:_x9-2,y:_y9-2,z:0})),"PieceMove"===anim.type?(_x9=origin.x+anim.cell.x*tilesize,_y9=origin.y+anim.cell.y*tilesize):z=Math.round(select.anim.y)):select.dest&&(_x9=origin.x+select.dest.x*tilesize,_y9=origin.y+select.dest.y*tilesize),"selection"):"pieces",layers[layer].push({image:_sprite2,x:_x9+1,y:_y9-1,z:z}),layers.shadows.push({image:sprites.pieces.shadow,x:_x9+1,y:_y9+3})}}catch(err){_didIteratorError10=!0,_image=err}finally{try{!_iteratorNormalCompletion10&&_iterator10.return&&_iterator10.return()}finally{if(_didIteratorError10)throw _image}}if(pointer.select&&(_y11=select.unit,_image=sprites.pieces[_y11.faction][_y11.type],preview=pointer.pos.x/view.scale-_image.width/2,_x11=pointer.pos.y/view.scale-_image.height-8,_y11=.75,select.valid||(_y11=.25),_y11&&layers.mirage.push({image:_image,x:preview,y:_x11,opacity:_y11})),cache.playerview&&(preview=cache.playerview,_x11=lerp_1(-preview.image.width,2,preview.anim.x),_y11=view.height-preview.image.height-2+1,layers.ui.push({image:preview.image,x:_x11,y:_y11})),cache.enemyview&&(deftag=cache.enemyview,_vs=deftag.image.width-1,_x13=view.width+lerp_1(_vs,-2-_vs,deftag.anim.x),button=view.height-deftag.image.height-2+1,layers.ui.push({image:deftag.image,x:_x13,y:button})),cache.forecast){var _vs=sprites.vs,deftag=_vs.width*cache.forecast.vs.anim.x,_x13=view.width/2-deftag/2,button=2*view.height/3-_vs.height/2;layers.ui.push({image:_vs,x:_x13,y:button,width:deftag}),deftag=cache.forecast.hp.left,_x13=lerp_1(-deftag.width,4,cache.forecast.vs.anim.x),button=22+button,layers.ui.unshift({image:deftag,x:_x13,y:button}),deftag=cache.forecast.hp.right,_x13=view.width+lerp_1(deftag.width,-4-deftag.width,cache.forecast.vs.anim.x),layers.ui.unshift({image:deftag,x:_x13,y:button}),deftag=cache.forecast.tags.atk,_x13=lerp_1(-deftag.width,4,cache.forecast.vs.anim.x),button=button-deftag.height-1,layers.ui.unshift({image:deftag,x:_x13,y:button}),deftag=cache.forecast.tags.def,_x13=view.width+lerp_1(deftag.width,-4-deftag.width,cache.forecast.vs.anim.x),layers.ui.unshift({image:deftag,x:_x13,y:button});for(var cached=cache.forecast,stats=Object.keys(cached.stats),i=0;i<stats.length;i++){var _x14=stats[i],_y14=cached.stats[_x14],_image2=_y14.image,_height=_image2.height*_y14.anim.x,_x14=view.width/2-_image2.width/2,_y14=2*view.height/3+28+14*i-_height/2;layers.ui.push({image:_image2,x:_x14,y:_y14,height:_height})}button=sprites.buttons.small,layers.ui.push({image:button,x:8,y:8})}for(layername in layers){layer=layers[layername],"ui"!==layername&&layer.sort(zsort);var _iteratorNormalCompletion11=!0,_didIteratorError11=!1,_iteratorError11=void 0;try{for(var _iterator11=layer[Symbol.iterator]();!(_iteratorNormalCompletion11=(_height2=_iterator11.next()).done);_iteratorNormalCompletion11=!0){var _node=_height2.value,_image3=_node.image,_x15=Math.round(_node.x),_y15=Math.round(_node.y-(_node.z||0)),_width2=Math.round(_node.width),_height2=Math.round(_node.height);0!==_width2&&0!==_height2&&(_width2=_width2||_image3.width,_height2=_height2||_image3.height,void 0!==_node.opacity?(context.globalAlpha=_node.opacity,context.drawImage(_image3,_x15,_y15,_width2,_height2),context.globalAlpha=1):context.drawImage(_image3,_x15,_y15,_width2,_height2))}}catch(err){_didIteratorError11=!0,_iteratorError11=err}finally{try{!_iteratorNormalCompletion11&&_iterator11.return&&_iterator11.return()}finally{if(_didIteratorError11)throw _iteratorError11}}}}(view)),state.select||pointer.select||!pointer.unit||state.time-pointer.time!=20||(game.phase.pending.includes(pointer.unit)&&(pointer.select=!0),actions.select(pointer.unit)),camera.follow&&state.select&&"PieceMove"===state.select.anim.type&&(cursor=state.select.anim,actions.centerCamera(cursor.cell)),Math.round(cache.camera.x)===Math.round(camera.pos.x)&&Math.round(cache.camera.y)===Math.round(camera.pos.y)||(cache.camera.x=camera.pos.x,cache.camera.y=camera.pos.y,state.dirty=!0),camera.pos.x+=camera.vel.x,camera.pos.y+=camera.vel.y,camera.vel.x+=((camera.target.x-camera.pos.x)/8-camera.vel.x)/2,camera.vel.y+=((camera.target.y-camera.pos.y)/8-camera.vel.y)/2,state.select&&state.select.cursor&&(cursor=state.select.cursor,Math.round(cache.cursor.x)===Math.round(cursor.pos.x)&&Math.round(cache.cursor.y)===Math.round(cursor.pos.y)||(cache.cursor.x=cursor.pos.x,cache.cursor.y=cursor.pos.y,state.dirty=!0),cursor.pos.x+=(cursor.target.x*tilesize-cursor.pos.x)/4,cursor.pos.y+=(cursor.target.y*tilesize-cursor.pos.y)/4);for(var i=0;i<state.anims.length;i++){var unit,enter,attacker$1,defender$1,expand,_anim=state.anims[i];_anim.done&&(state.anims.splice(i--,1),"RangeShrink"===_anim.type?state.anims.find(function(anim){return"RangeExpand"===anim.type})||(cache.range=null):"PreviewExit"===_anim.type?cache[_anim.id]=null:"PieceDrop"===_anim.type?state.select=null:"PieceMove"===_anim.type&&(cache.playerview&&(attacker$1=anims.PreviewExit.create(cache.playerview.anim.x,"playerview"),cache.playerview.anim.done=!0,cache.playerview.anim=attacker$1,state.anims.push(attacker$1)),cache.enemyview&&(defender$1=anims.PreviewExit.create(cache.enemyview.anim.x,"enemyview"),cache.enemyview.anim.done=!0,cache.enemyview.anim=defender$1,state.anims.push(defender$1)),unit=state.select.unit,state.select.anim=null,camera.follow&&(camera.follow=!1),move(unit,state.select.dest,map),state.target?(state.mode="attack",expand=anims.PieceLift.create(),enter=anims.EaseOut.create(15),state.anims.push(enter,expand),state.select.path=null,state.select.anim=expand,attacker$1=state.select.unit,defender$1=state.target,expand={center:attacker$1.cell,range:rng(attacker$1),squares:neighborhood(attacker$1.cell,rng(attacker$1)).map(function(cell){return{cell:cell,type:"attack"}})},expand=anims.RangeExpand.create(expand),state.anims.push(expand),cache.range=expand.range,cache.forecast={vs:{image:sprites.vs,anim:enter},hp:{left:function(gradient,end,x){end=end||0;var width=x.bars,start=x.palette,hp=copy(width.left),x=(gradient.stats.hp-end)/gradient.stats.hp,width=Math.round(maxwidth*x),x=maxwidth-width+6,end=getGradient(gradient.stats.hp-end,gradient.faction,start,!0),start=(gradient=_slicedToArray(end,2))[0],end=gradient[1];return(gradient=hp.createLinearGradient(2+x,0,2+x+(width-1),0)).addColorStop(0,rgb.apply(void 0,_toConsumableArray(start))),gradient.addColorStop(1,rgb.apply(void 0,_toConsumableArray(end))),hp.fillStyle=gradient,hp.fillRect(x,2,width-1,2),hp.fillRect(1+x,4,width-1,2),hp.fillRect(2+x,6,width-1,1),hp.canvas}(attacker$1,dmg(defender$1,attacker$1),sprites),right:function(gradient,end,hp){end=end||0;var width=hp.bars,start=hp.palette,hp=copy(width.right),width=(gradient.stats.hp-end)/gradient.stats.hp,width=Math.round(maxwidth*width),end=getGradient(gradient.stats.hp-end,gradient.faction,start),start=(gradient=_slicedToArray(end,2))[0],end=gradient[1];return(gradient=hp.createLinearGradient(5,0,5+width,0)).addColorStop(0,rgb.apply(void 0,_toConsumableArray(start))),gradient.addColorStop(1,rgb.apply(void 0,_toConsumableArray(end))),hp.fillStyle=gradient,hp.fillRect(7,2,width,2),hp.fillRect(6,4,width,2),hp.fillRect(5,6,width,1),hp.canvas}(defender$1,dmg(attacker$1,defender$1),sprites)},tags:{atk:renderNameTag(attacker$1.name,attacker$1.faction,sprites),def:renderNameTag(defender$1.name,defender$1.faction,sprites)},stats:{wpn:{image:function(attacker,defender,sprites){var palette=sprites.palette,panel=renderBase("WPN",sprites).getContext("2d"),badges=create(panel.canvas.width,panel.canvas.height);return badges.drawImage(getBadge(attacker,sprites.badges),4,1),badges.drawImage(getBadge(defender,sprites.badges),51,1),panel.drawImage(drawShadow(badges.canvas,palette.sage),0,0),panel.canvas}(attacker$1,defender$1,sprites),anim:function(){var anim=anims.EaseOut.create(10,10);return state.anims.push(anim),anim}()},dmg:{image:function(dmg2,defender,sprites){var dmg1=dmg(dmg2,defender),dmg2=dmg(defender,dmg2);return null===dmg1&&(dmg1="-"),(null===dmg2||dmg1>=defender.stats.hp)&&(dmg2="-"),renderPanel("DMG",dmg1,dmg2,sprites)}(attacker$1,defender$1,sprites),anim:function(){var anim=anims.EaseOut.create(10,13);return state.anims.push(anim),anim}()},hit:{image:function(attacker,defender,sprites){var hit1=hit(attacker,defender),hit2=hit(defender,attacker);return(null===hit1||hit1<0)&&(hit1="-"),(null===hit2||hit2<0||dmg(attacker,defender)>=defender.stats.hp)&&(hit2="-"),renderPanel("HIT",hit1,hit2,sprites)}(attacker$1,defender$1,sprites),anim:function(){var anim=anims.EaseOut.create(10,16);return state.anims.push(anim),anim}()}}}):(endTurn(unit,game),state.select=null))),anims[_anim.type].update(_anim),state.dirty=!0}requestAnimationFrame(update)})}function zsort(a,b){return a.y+a.image.height/2-(b.y+b.image.height/2)}var path,state=function(map){var units=map.units.map(function(unit){return function(name,type,faction,cell,stats){return{name:name,type:type,faction:faction,cell:cell,stats:stats}}.apply(void 0,_toConsumableArray(unit))});return{map:{width:map.width,height:map.height,units:units},phase:{faction:"player",pending:units.filter(function(unit){return"player"===unit.faction})}}}({id:"test",width:9,height:9,units:[["Arthur","soldier","enemy",{x:1,y:4},{hp:12,atk:8,hit:7,def:3,spd:5,element:"holy"}],["Percy","knight","enemy",{x:3,y:3},{hp:14,atk:7,hit:8,def:6,spd:2,element:"plant"}],["Merlin","mage","enemy",{x:2,y:6},{hp:7,atk:8,hit:7,def:2,spd:3,element:"ice"}],["Gilda","fighter","player",{x:5,y:5},{hp:15,atk:9,hit:6,def:3,spd:4,element:"fire"}],["Kidd","thief","player",{x:6,y:2},{hp:8,atk:5,hit:8,def:2,spd:6,element:"dark"}],["Napi","archer","player",{x:4,y:1},{hp:9,atk:8,hit:9,def:3,spd:5,element:"volt"}]]});path="sprites.png",new Promise(function(resolve,reject){var image=new Image;image.src=path,image.onload=function(){resolve(image)},image.onerror=function(){reject(new Error("Failed to load image `"+path+"`"))}}).then(function(view){view=function(width,height,sprites){return{native:{width:width,height:height},width:window.innerWidth,height:window.innerHeight,scale:1,sprites:sprites,element:document.createElement("canvas"),game:null,state:{anims:[],time:0,dirty:!1,camera:{pos:{x:0,y:0},vel:{x:0,y:0},target:{x:0,y:0}},select:null,target:null,mode:"select",pointer:{pos:null,time:0,clicking:!1,unit:!1,select:!1,pressed:null,offset:null}},cache:{map:null,camera:{x:0,y:0},cursor:{x:0,y:0},playerview:null,enemyview:null,vs:null,hp:null,forecast:null},layers:{map:[],range:[],shadows:[],arrows:[],pieces:[],markers:[],selection:[],mirage:[],ui:[]}}}(160,160,normalize(view));document.body.appendChild(view.element),init(view,state)})}();