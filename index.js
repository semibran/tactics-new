"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_slicedToArray=function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return function(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}!function(){var srcmap={x2:[168,178,16,16],palette:[183,97,6,6],"select-glow":[170,194,16,18],"icon-ice":[184,24,10,10],"icon8-sword":[92,140,8,8],"select-cursor":[206,140,17,17],"icon6-hat":[194,214,6,6],"icon6-dagger":[184,34,6,6],tag:[223,140,5,12],"select-arrows":[120,0,64,64],"icon6-shield":[194,24,6,6],"icon6-bow":[216,10,6,6],"icon-fire":[216,0,10,10],"icon8-axe":[220,77,8,8],"font-serif":[0,0,120,77],"icon-volt":[180,64,10,10],"icon6-cudgel":[190,64,6,6],"icon-dark":[0,188,10,10],"font-six":[0,176,50,12],buttons:[0,140,54,36],"font-smallcaps":[170,77,50,20],"font-smallcaps-radiant":[100,214,80,14],bars:[100,140,68,27],"font-numbers":[120,64,60,12],"icon8-shield":[206,157,8,8],"icon8-dagger":[186,194,8,8],"font-standard":[100,77,70,63],hp:[54,140,38,38],"icon8-hat":[184,178,8,8],labels:[170,97,13,18],"icon6-sword":[0,198,6,6],"icon8-bow":[170,115,8,8],piece:[180,214,14,14],"icon-holy":[54,198,10,10],"font-standard-bold":[0,77,100,63],"icon-plant":[74,178,10,10],vs:[168,140,38,38],"icon6-axe":[10,188,6,6],bar:[100,167,68,27],"select-ring":[54,178,20,20],"font-smallcaps-bold":[100,194,70,20],badges:[184,0,32,24]},fonts={standard:{id:"standard",cellsize:{width:7,height:9},charsize:{width:5,height:7},exceptions:{1:{width:3},I:{width:3},f:{width:4},g:{height:9},i:{width:1},j:{width:2,height:8},k:{width:4},l:{width:1,x:0},m:{width:7},p:{height:9},q:{height:9},r:{width:4},t:{width:4},w:{width:7},y:{height:9},",":{width:2,height:9},".":{width:1},"!":{width:1},"'":{width:1},"(":{width:3},")":{width:3}},spacing:{char:1,word:4,line:5},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.!?","abcdefghij","klmnopqrst","uvwxyz'()"]},standardBold:{id:"standard-bold",cellsize:{width:10,height:9},charsize:{width:6,height:7},exceptions:{1:{width:4},I:{width:4},J:{width:5},M:{width:7},W:{width:7},f:{width:5},g:{height:9},i:{width:2},j:{width:5},l:{width:2,x:0},m:{width:10},p:{height:9},q:{height:9},w:{width:10},y:{height:9},",":{width:2,height:8},".":{width:2},"!":{width:2},"?":{width:6},"'":{width:2},"(":{width:4},")":{width:4}},spacing:{char:1,word:4,line:5},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.!?","abcdefghij","klmnopqrst","uvwxyz'()"]},serif:{id:"serif",cellsize:{width:12,height:11},charsize:{width:8,height:9},exceptions:{A:{width:9},D:{width:9},H:{width:9},I:{width:4},J:{width:5},K:{width:9},M:{width:10},N:{width:9},Q:{width:9,height:11},S:{width:7},U:{width:9},a:{width:7},b:{width:7},c:{width:6},d:{width:7},e:{width:6},f:{width:5},g:{width:7,height:11},h:{width:8},i:{width:4},j:{width:4,height:11},k:{width:8},l:{width:4},m:{width:12},n:{width:8},o:{width:6},p:{width:7,height:11},q:{width:7,height:11},r:{width:7},s:{width:6},t:{width:5},v:{width:7},w:{width:12},x:{width:7},y:{width:8,height:11},z:{width:7}},spacing:{char:1,word:4,line:5},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ    ","abcdefghij","klmnopqrst","uvwxyz"]},smallcaps:{id:"smallcaps",cellsize:{width:5,height:5},charsize:{width:5,height:5},exceptions:{1:{width:3},",":{width:1},".":{width:1},"!":{width:1},"/":{width:3}},spacing:{char:1,word:3,line:2},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.!/"]},smallcapsBold:{id:"smallcaps-bold",cellsize:{width:7,height:5},charsize:{width:6,height:5},exceptions:{1:{width:4},M:{width:7},W:{width:7},",":{width:2},".":{width:2},"-":{width:4},"/":{width:3}},spacing:{char:1,word:4,line:2},layout:["0123456789","ABCDEFGHIJ","KLMNOPQRST","UVWXYZ,.-/"]},smallcapsRadiant:{id:"smallcaps-radiant",cellsize:{width:8,height:7},charsize:{width:8,height:7},exceptions:{1:{width:6},"/":{width:5}},spacing:{char:-1,word:4,line:2},layout:["0123456789","/         "]},six:{id:"six",cellsize:{width:5,height:6},charsize:{width:5,height:6},exceptions:{1:{width:3},"/":{width:3}},spacing:{char:1,word:3,line:2},layout:["0123456789","/"]},numbers:{id:"numbers",cellsize:{width:6,height:6},charsize:{width:6,height:6},exceptions:{1:{width:4},"/":{width:3}},spacing:{char:1,word:3,line:2},layout:["0123456789","/"]}};function extract(image,x,y,width,height){var canvas=document.createElement("canvas"),context=canvas.getContext("2d");return canvas.width=width,canvas.height=height,context.drawImage(image,-x,-y),canvas}function fromCanvas(image){return image.getContext("2d").getImageData(0,0,image.width,image.height)}function toCanvas(data){var canvas=document.createElement("canvas"),context=canvas.getContext("2d");return canvas.width=data.width,canvas.height=data.height,context.putImageData(data,0,0),canvas}function replace(image,oldColor,newColor){oldColor[3]||((oldColor=oldColor.slice())[3]=255),newColor[3]||((newColor=newColor.slice())[3]=255);for(var i=0;i<image.data.length;i+=4){for(var c=0;c<4&&image.data[i+c]===oldColor[c];c++);if(4===c)for(c=0;c<4;c++)image.data[i+c]=newColor[c]}return image}var matrix=[["white","opal","pink","lime","opalhp","redhp"],["black","blue","red","green",null,"orangehp"],["silver","navy","purple","teal","beige","yellowhp"],["gray",null,"maroon","moss","taupe","greenhp"],["coal",null,"yellow","gold","brass","bluehp"],["jet",null,"cream","sage","brown","indigohp"]],mappings={hp:{opal:"opal",red:"red",orange:"orangehp",yellow:"yellowhp",green:"greenhp",blue:"bluehp",indigo:"indigohp"},factions:{player:{light:"opal",normal:"blue",dark:"navy"},enemy:{light:"pink",normal:"red",dark:"purple"},ally:{light:"lime",normal:"green",dark:"teal"}}};function match(image){for(var palette={},data=function(image){var canvas=document.createElement("canvas"),context=image.getContext("2d");return canvas.width=image.width,canvas.height=image.height,context.drawImage(canvas,0,0),context.getImageData(0,0,image.width,image.height)}(image),_y2=0;_y2<matrix.length;_y2++)for(var _x2=0;_x2<matrix[_y2].length;_x2++){var colorname=matrix[_y2][_x2];colorname&&(palette[colorname]=function(image,i,y){return i=4*(y*image.width+i),[image.data[i],image.data[1+i],image.data[2+i],image.data[3+i]]}(data,_x2,_y2))}return function assign(obj,mappings){for(var n in mappings)"object"===_typeof(mappings[n])?(obj[n]={},assign(obj[n],mappings[n])):obj[n]=palette[mappings[n]]}(palette,mappings),palette}function create(width,height){var canvas=document.createElement("canvas");return canvas.width=width,canvas.height=height,canvas.getContext("2d")}function copy(canvas){var result=create(canvas.width,canvas.height);return result.drawImage(canvas,0,0),result}function replace$1(canvas,oldColor,newColor){return toCanvas(replace(fromCanvas(canvas),oldColor,newColor))}function recolor$1(canvas,newColor){return toCanvas(function(image,newColor){newColor[3]||((newColor=newColor.slice())[3]=255);for(var i=0;i<image.data.length;i+=4)if(0!==image.data[i+3])for(var c=0;c<4;c++)image.data[i+c]=newColor[c];return image}(fromCanvas(canvas),newColor))}function disasmSelect(images,palette){var faction,select={glow:{},ring:{},cursor:{},arrows:{}};for(faction in palette.factions){var cursor=palette.factions[faction];select.glow[faction]=images["select-glow"];var cursorbase=images["select-ring"],ringshadow=replace$1(cursorbase,palette.white,cursor.light),cursorshadow=create(cursorbase.width,cursorbase.height+1);cursorshadow.drawImage(ringshadow,0,1),cursorshadow.drawImage(cursorbase,0,0),select.ring[faction]=cursorshadow.canvas;cursorbase=images["select-cursor"],cursorshadow=replace$1(cursorbase,palette.white,cursor.light),cursor=create(cursorbase.width+1,cursorbase.height+1);cursor.drawImage(cursorshadow,1,1),cursor.drawImage(cursorbase,0,0),select.cursor[faction]=cursor.canvas,select.arrows[faction]=function(images,palette,sheet){return sheet=palette.factions[sheet],{left:extract(sheet=replace$1(images["select-arrows"],palette.black,sheet.light),0,0,16,16),right:extract(sheet,16,0,16,16),up:extract(sheet,32,0,16,16),down:extract(sheet,48,0,16,16),leftStub:extract(sheet,0,16,16,16),rightStub:extract(sheet,16,16,16,16),upStub:extract(sheet,32,16,16,16),downStub:extract(sheet,48,16,16,16),upleft:extract(sheet,0,32,16,16),upright:extract(sheet,16,32,16,16),downleft:extract(sheet,32,32,16,16),downright:extract(sheet,48,32,16,16),leftright:extract(sheet,0,48,16,16),updown:extract(sheet,16,48,16,16)}}(images,palette,faction)}return select}function rgb(r,g,b){return"rgb("+r+", "+g+", "+b+")"}function replaceColor(canvas,oldColors,newColors){for(var context=canvas.getContext("2d"),image=context.getImageData(0,0,canvas.width,canvas.height),i=0;i<image.data.length;i+=4){for(var o=0;o<oldColors.length;o++){for(var c=0;c<4&&image.data[i+c]===oldColors[o][c];c++);if(4===c)break}if(o<oldColors.length)for(c=0;c<4;c++)image.data[i+c]=newColors[o][c]}return context.putImageData(image,0,0),canvas}function makeCharmap(image,font,color,stroke){if(!image)throw new Error("No image found for font "+font.id+". Try rebuilding your spritesheet.");var charmap={},cols=image.width/font.cellsize.width,rows=image.height/font.cellsize.height;color&&(image=replace$1(image,[255,255,255,255],color));for(var row=0;row<rows;row++)for(var col=0;col<cols;col++){var char=font.layout[row][col];if(char){var axis,size={width:font.charsize.width,height:font.charsize.height},offsets=font.exceptions[char];for(axis in offsets)size[axis]=offsets[axis];var base=extract(image,col*font.cellsize.width,row*font.cellsize.height,size.width,size.height);charmap[char]=stroke?function(image,color){for(var result=create(image.width+2,image.height+2),base=recolor$1(image,color),_y3=0;_y3<3;_y3++)for(var _x3=0;_x3<3;_x3++)1===_x3&&1===_y3||result.drawImage(base,_x3,_y3);return result.drawImage(image,1,1),result.canvas}(base,stroke):base}}return charmap}function drawShadow(image,shadow){var result=create(image.width+1,image.height+1),shadow=recolor$1(image,shadow);return result.drawImage(shadow,0,1),result.drawImage(shadow,1,0),result.drawImage(shadow,1,1),result.drawImage(image,0,0),result.canvas}function renderText(content,style,_didIteratorError2){var _iteratorError2=style.color?style.stroke?style.color+"+"+style.stroke:style.color:"default",font=style.font;if(!font)throw new Error("Attempting to render an unregistered font. Is your font exported by fonts/index.js?");font.cache[_iteratorError2]||(font.cache[_iteratorError2]=makeCharmap(font.image,font.data,style.color,style.stroke));var cached=font.cache[_iteratorError2];content=content.toString(),_didIteratorError2=_didIteratorError2||function(content,font,stroked){var width=0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _iterator=content[Symbol.iterator]();!(_iteratorNormalCompletion=(image=_iterator.next()).done);_iteratorNormalCompletion=!0){var cache,image,char=image.value;" "!==char?(image=(image=(cache=font.cache.default)[char])||cache[char.toUpperCase()])&&(width+=image.width+font.data.spacing.char):width+=font.data.spacing.word}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return width&&(width-=font.data.spacing.char),stroked&&(width+=2),width}(content,font,style.stroke);_iteratorError2=font.data.cellsize.height;style.stroke&&(_iteratorError2+=2);var text=create(_didIteratorError2,_iteratorError2),x=0,kerning=font.data.spacing.char;style.stroke&&(kerning-=2);var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _iterator2=content[Symbol.iterator]();!(_iteratorNormalCompletion2=(image=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var image,char=image.value;" "!==char?(image=(image=cached[char])||cached[char.toUpperCase()])&&(text.drawImage(image,x,0),x+=image.width+kerning):x+=font.data.spacing.word}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return style.shadow?drawShadow(text.canvas,style.shadow):text.canvas}var texts={back:"Cancel",move:"Move",wait:"Wait",attack:"Attack",stats:"Stats",undo:"Undo"};function disasmBars(image,palette){var bars={small:function(image,newColors){newColors=[newColors.cream,newColors.brass,newColors.coal,newColors.jet];return replaceColor(image,[[255,255,255,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],newColors),image}(extract(image,0,0,51,5),palette)};return replaceColor(image,[[255,255,255,255],[204,204,204,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],[palette.white,palette.opal,palette.gray,palette.coal,palette.jet]),bars.left=extract(image,0,16,68,11),bars.right=extract(image,0,5,68,11),bars}var white=[255,255,255,255],shadowcolor=[0,0,0,191];function disasmFonts(images,fonts,palette){var fontname,result={};for(fontname in fonts){var font=fonts[fontname],image=images["font-"+font.id];result[fontname]=function(image,data,palette){var charmap=makeCharmap(image,data);return{image:image,data:data,cache:_defineProperty({default:charmap},palette.white,charmap)}}(image,font,palette)}return result}function renderArrow(path,sprites){for(var nodes=[],stubdir=null,right=0,bottom=0,i=0;i<path.length;i++){var cell=path[i],x=cell.x,sprite=cell.y,l=!1,r=!1,u=!1,d=!1;right<x&&(right=x),bottom<sprite&&(bottom=sprite);sprite=path[i-1];sprite&&(1===(dx=cell.x-sprite.x)?l=!0:-1===dx&&(r=!0),1===(dy=cell.y-sprite.y)?u=!0:-1===dy&&(d=!0));var dx,dy,sprite=path[i+1];sprite&&(-1===(dx=sprite.x-cell.x)?l=!0:1===dx&&(r=!0),-1===(dy=sprite.y-cell.y)?u=!0:1===dy&&(d=!0)),(l||r||u||d)&&(sprite=null,!i&&l?stubdir="left":!i&&r?stubdir="right":!i&&u?stubdir="up":!i&&d?stubdir="down":u&&l?sprite="upleft":u&&r?sprite="upright":d&&l?sprite="downleft":d&&r?sprite="downright":1===i&&"left"===stubdir&&2<path.length?sprite="leftStub":1===i&&"right"===stubdir&&2<path.length?sprite="rightStub":1===i&&"up"===stubdir&&2<path.length?sprite="upStub":1===i&&"down"===stubdir&&2<path.length?sprite="downStub":l&&r?sprite="leftright":u&&d?sprite="updown":l?sprite="left":r?sprite="right":u?sprite="up":d&&(sprite="down"),sprite&&(sprite=sprites[sprite],nodes.push({image:sprite,x:cell.x*sprite.width,y:cell.y*sprite.height})))}var arrow=function(width,height){var canvas=document.createElement("canvas");return canvas.width=width,canvas.height=height,canvas.getContext("2d")}(16*(right+1),16*(bottom+1)),_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _iterator3=nodes[Symbol.iterator]();!(_iteratorNormalCompletion3=(node=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var node=node.value;arrow.drawImage(node.image,node.x,node.y)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return arrow.canvas}function normalize(enemyColors){var image,newColors,tags,oldColors,yellows,playerColors,images=function disasm(sheet,srcmap){var id,_x,_y,w,h,sprites={};for(id in srcmap)Array.isArray(srcmap[id])?(_x=(h=_slicedToArray(srcmap[id],4))[0],_y=h[1],w=h[2],h=h[3],sprites[id]=extract(sheet,_x,_y,w,h)):sprites[id]=disasm(sheet,srcmap[id]);return sprites}(enemyColors,srcmap),palette=match(images.palette),icons=function(images){var name,icons={small:{},types:{axe:"fighter",bow:"archer",dagger:"thief",hat:"mage",shield:"knight",sword:"soldier"},fire:images["icon-fire"],ice:images["icon-ice"],volt:images["icon-volt"],plant:images["icon-plant"],holy:images["icon-holy"],dark:images["icon-dark"]};for(name in icons.types){var type=icons.types[name];icons.small[name]=images["icon6-"+name],icons.small[type]=images["icon6-"+name],icons[name]=images["icon8-"+name],icons[type]=images["icon8-"+name]}return icons}(images),select=disasmSelect(images,palette),allyColors=disasmFonts(images,fonts,palette);return{icons:icons,palette:palette,select:select,fonts:allyColors,Arrow:function(path,faction){return renderArrow(path,select.arrows[faction])},squares:function(){var move=create(16,16);move.globalAlpha=.25,move.fillStyle="blue",move.fillRect(0,0,15,15);var attack=create(16,16);return attack.globalAlpha=.25,attack.fillStyle="red",attack.fillRect(0,0,15,15),{move:move.canvas,attack:attack.canvas}}(),buttons:function(image,fonts,palette){var name,buttons={back:extract(image,0,0,18,18),move:extract(image,18,0,18,18),wait:extract(image,36,0,18,18),attack:extract(image,0,18,18,18),stats:extract(image,18,18,18,18),undo:extract(image,36,18,18,18)};for(name in buttons){var _image=buttons[name],text=renderText(texts[name],{font:fonts.standard,color:palette.white,stroke:palette.jet}),result=create(_image.width+2+text.width,_image.height);result.drawImage(_image,0,0),result.drawImage(text,_image.width-6,_image.height-text.height+1),buttons[name]=result.canvas}return buttons}(images.buttons,allyColors,palette),vs:function(image,palette){return replaceColor(image,[[255,255,255,255],[204,204,204,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],[palette.white,palette.opal,palette.gray,palette.brown,palette.jet]),image}(images.vs,palette),x2:images.x2,tag:(image=images.tag,tags={},oldColors=[[255,255,255,255],[204,204,204,255],[153,153,153,255],[102,102,102,255],[51,51,51,255],[0,0,0,255]],yellows=[(newColors=palette).yellow,newColors.gold,newColors.brass],playerColors=[newColors.opal,newColors.coal,newColors.jet],enemyColors=[newColors.pink,newColors.maroon,newColors.jet],allyColors=[newColors.lime,newColors.moss,newColors.jet],newColors=yellows.concat(playerColors),replaceColor(image,oldColors,newColors),tags.player={start:extract(image,0,0,2,12),end:extract(image,2,0,3,12),palette:playerColors},oldColors=newColors,newColors=yellows.concat(enemyColors),replaceColor(image=copy(image).canvas,oldColors,newColors),tags.enemy={start:extract(image,0,0,2,12),end:extract(image,2,0,3,12),palette:enemyColors},oldColors=newColors,newColors=yellows.concat(allyColors),replaceColor(image=copy(image).canvas,oldColors,newColors),tags.ally={start:extract(image,0,0,2,12),end:extract(image,2,0,3,12),palette:allyColors},tags),bars:disasmBars(images.bars,palette),labels:function(image,palette){return replaceColor(image,[[255,255,255,255],[204,204,204,255],[153,153,153,255],[102,102,102,255]],[palette.yellow,palette.gold,palette.brass,palette.brown]),{hp:extract(image,0,0,13,9),ap:extract(image,0,9,13,9)}}(images.labels,palette),badges:function(image,palette){return replaceColor(image,[[255,255,255,255],[204,204,204,255],[102,102,102,255],[0,0,0,255]],[palette.white,palette.opal,palette.coal,palette.jet]),{sword:extract(image,0,0,8,8),lance:extract(image,8,0,8,8),axe:extract(image,16,0,8,8),bow:extract(image,24,0,8,8),shield:extract(image,0,8,8,8),target:extract(image,8,8,8,8),wing:extract(image,16,8,8,8),dagger:extract(image,24,8,8,8),fire:extract(image,0,16,8,8),ice:extract(image,8,16,8,8),volt:extract(image,16,16,8,8),dark:extract(image,24,16,8,8)}}(images.badges,palette),pieces:function(base,icons,palette){var faction,pieces={done:{},flash:Piece(base,null,{normal:white,dark:white}),shadow:recolor$1(base,shadowcolor)};for(faction in palette.factions){pieces[faction]={},pieces.done[faction]={};var iconname,subpal=palette.factions[faction];for(iconname in icons.types){var unittype=icons.types[iconname],done=icons.small[iconname],_piece=Piece(base,done,subpal),done=Piece(base,done,{light:subpal.normal,normal:subpal.dark,dark:palette.black});pieces[faction][unittype]=_piece,pieces.done[faction][unittype]=done}}return pieces;function Piece(piece,icon,colors){var template=recolor$1(piece,colors.normal),tmp=colors.dark!==palette.black?recolor$1(piece,colors.dark):piece,piece=create(piece.width,piece.height+2);if(piece.drawImage(tmp,0,2),piece.drawImage(template,0,0),!icon)return piece.canvas;tmp=create(8,8),template=icon.getContext("2d").getImageData(0,0,icon.width,icon.height);return replace(template,palette.white,colors.light),tmp.putImageData(template,0,0),piece.drawImage(tmp.canvas,4,5),tmp=create(8,8),replace(template=icon.getContext("2d").getImageData(0,0,icon.width,icon.height),palette.white,colors.dark),tmp.putImageData(template,0,0),piece.drawImage(tmp.canvas,4,4),piece.canvas}}(images.piece,icons,palette)}}function equals(a,b){return a.x===b.x&&a.y===b.y}function steps(a,b){return Math.abs(b.x-a.x)+Math.abs(b.y-a.y)}function neighbors(cell){return[{x:cell.x-1,y:cell.y},{x:cell.x+1,y:cell.y},{x:cell.x,y:cell.y-1},{x:cell.x,y:cell.y+1}]}function create$3(range){return{id:"RangeExpand",done:!1,time:0,src:function(range){for(var sorted=new Array(range.radius+1),i=0;i<sorted.length;i++)sorted[i]=[];var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _iterator4=range.squares[Symbol.iterator]();!(_iteratorNormalCompletion4=(dist=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var square=dist.value,dist=steps(range.center,square.cell);sorted[dist].push(square)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}return sorted}(range),range:{center:range.center,radius:range.radius,squares:[]}}}var RangeExpand=Object.freeze({__proto__:null,create:create$3,update:function(anim){var _anim$range$squares,edges;anim.done||(edges=anim.src[anim.time],(_anim$range$squares=anim.range.squares).push.apply(_anim$range$squares,_toConsumableArray(edges)),anim.time++===anim.range.radius&&(anim.done=!0))}});function create$4(range){return{id:"RangeShrink",done:!1,range:range}}var RangeShrink=Object.freeze({__proto__:null,create:create$4,update:function(anim){if(!anim.done){for(var i=0;i<anim.range.squares.length;i++){var square=anim.range.squares[i];steps(anim.range.center,square.cell)===anim.range.radius&&anim.range.squares.splice(i--,1)}--anim.range.radius<0&&(anim.done=!0)}}});function easeOut(t){return-t*(t-2)}var compRange=Object.freeze({__proto__:null,create:function(){return{type:"PreviewEnter",done:!1,x:0,time:0}},update:function(anim){var t;anim.done||(t=anim.time/10,anim.x=easeOut(t),10==anim.time++&&(anim.done=!0))}});var compPreview=Object.freeze({__proto__:null,create:function(x,id){return{type:"PreviewExit",blocking:!0,done:!1,x:x||1,id:id}},update:function(anim){anim.done||(anim.x-=.2,anim.x<0&&(anim.x=0,anim.done=!0))}}),height=4;function create$7(opts){return{id:"PieceLift",done:!1,opts:opts,y:0,time:0,floating:!1}}var compVs=Object.freeze({__proto__:null,height:height,create:create$7,update:function(anim){var t;anim.done||(anim.time++,anim.floating?(t=anim.time%120/120,anim.y=height+Math.sin(2*Math.PI*t)):++anim.y===height&&(anim.floating=!0))}});function create$8(opts){return{id:"PieceDrop",done:!1,opts:opts=Object.assign({y:height},opts),y:opts.y||height}}var compHp=Object.freeze({__proto__:null,create:create$8,update:function(anim){anim.done||--anim.y<=0&&(anim.y=0,anim.done=!0)}});var lerp_1=function(v0,v1,t){return v0*(1-t)+v1*t};var pieceMove=Object.freeze({__proto__:null,create:function(path,opts){return{id:"PieceMove",blocking:!0,done:!1,opts:opts,time:0,path:path,cell:{x:path[0].x,y:path[0].y}}},update:function(anim){if(anim.done)return!1;var next=Math.floor(anim.time/5),t=anim.time%5/5,cell=anim.path[next];return(next=anim.path[next+1])?(anim.cell.x=lerp_1(cell.x,next.x,t),anim.cell.y=lerp_1(cell.y,next.y,t)):(anim.cell.x=cell.x,anim.cell.y=cell.y,anim.done=!0),anim.time++,!0}});function create$a(src,dist,opts){var disp_x=dist.x-src.x,disp_y=dist.y-src.y,dist=Math.sqrt(disp_x*disp_x+disp_y*disp_y);return{id:"PieceAttack",src:src,norm:{x:disp_x/dist,y:disp_y/dist},cell:{x:src.x,y:src.y},opts:opts,time:0,blocking:!0,connect:!1}}var eileen=Object.freeze({__proto__:null,create:create$a,update:function(anim){var steps;anim.done||(steps=anim.time<=7?anim.time:7-(anim.time-7),8<=anim.time&&(anim.connect=!0),anim.cell.x=anim.src.x+anim.norm.x/8*steps,anim.cell.y=anim.src.y+anim.norm.y/8*steps,15==++anim.time&&(anim.done=!0))}});var goblin1=Object.freeze({__proto__:null,create:function(opts){return{id:"PieceFade",done:!1,opts:opts,time:0,visible:!0}},update:function(anim){anim.done||(anim.visible=!anim.visible,30<=++anim.time&&(anim.done=!0))}});function create$c(src,dist,opts){var disp_x=dist.x-src.x,disp_y=dist.y-src.y,dist=Math.sqrt(disp_x*disp_x+disp_y*disp_y);return{id:"PieceFlinch",src:src,norm:{x:disp_x/dist,y:disp_y/dist},cell:{x:src.x,y:src.y},opts:opts,time:0,flashing:!1,blocking:!0,connect:!1}}var troll2=Object.freeze({__proto__:null,create:create$c,update:function(anim){var steps;anim.done||(steps=anim.time<=10?anim.time:10-(anim.time-10),anim.cell.x=anim.src.x-anim.norm.x/32*steps,anim.cell.y=anim.src.y-anim.norm.y/32*steps,anim.flashing=!anim.flashing,20==++anim.time&&(anim.done=!0))}});function create$d(duration,data){return{id:"EaseOut",done:!1,duration:duration,data:Object.assign({delay:0},data),x:0,time:0}}var irving=Object.freeze({__proto__:null,create:create$d,update:function(anim){var t;anim.done||(anim.time++,t=Math.max(0,anim.time-anim.data.delay)/anim.duration,anim.x=easeOut(t),anim.time-anim.data.delay>=anim.duration&&(anim.done=!0))}});function create$e(duration,opts){return{id:"EaseLinear",done:!1,duration:duration,src:(opts=Object.assign({src:0,dest:1,delay:0},opts)).src||0,dest:void 0===opts.dest?1:opts.dest,x:opts.src||0,opts:opts,time:0}}function update$b(anim){var time;anim.done||(anim.time++,time=Math.max(0,anim.time-anim.opts.delay),anim.x=lerp_1(anim.opts.src,anim.opts.dest,time/anim.duration),time>=anim.duration&&(anim.done=!0))}var anims=Object.freeze({__proto__:null,create:create$e,update:update$b});function getAugmentedNamespace(n){if(n.__esModule)return n;var a=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach(function(k){var d=Object.getOwnPropertyDescriptor(n,k);Object.defineProperty(a,k,d.get?d:{enumerable:!0,get:function(){return n[k]}})}),a}var RangeExpand=getAugmentedNamespace(RangeExpand),RangeShrink=getAugmentedNamespace(RangeShrink),compRange=getAugmentedNamespace(compRange),compPreview=getAugmentedNamespace(compPreview),compVs=getAugmentedNamespace(compVs),compHp=getAugmentedNamespace(compHp),PieceMove=getAugmentedNamespace(pieceMove),eileen=getAugmentedNamespace(eileen),PieceFade=getAugmentedNamespace(goblin1),goblin1=getAugmentedNamespace(troll2),troll2=getAugmentedNamespace(irving),irving=getAugmentedNamespace(anims),anims={RangeExpand:RangeExpand,RangeShrink:RangeShrink,PreviewEnter:compRange,PreviewExit:compPreview,PieceLift:compVs,PieceDrop:compHp,PieceMove:PieceMove,PieceAttack:eileen,PieceFade:PieceFade,PieceFlinch:goblin1,EaseOut:troll2,EaseLinear:irving},Anims=Object.freeze(Object.assign(Object.create(null),anims,{default:anims,RangeExpand:RangeExpand,RangeShrink:RangeShrink,PreviewEnter:compRange,PreviewExit:compPreview,PieceLift:compVs,PieceDrop:compHp,PieceMove:PieceMove,PieceAttack:eileen,PieceFade:PieceFade,PieceFlinch:goblin1,EaseOut:troll2,EaseLinear:irving}));function pan(camera,bottom,left){var right=left.pos.x-left.presspos.x,top=left.pos.y-left.presspos.y;camera.target.x=(right+camera.offset.x)/camera.zoom,camera.target.y=(top+camera.offset.y)/camera.zoom;left=bottom.image.width/2,right=-bottom.image.width/2,top=bottom.image.height/2,bottom=-bottom.image.height/2;camera.target.x>left?camera.target.x=left:camera.target.x<right&&(camera.target.x=right),camera.target.y>top?camera.target.y=top:camera.target.y<bottom&&(camera.target.y=bottom)}function center(camera,map,cell){camera.target.x=map.image.width/2-(cell.x+.5)*map.tilesize,camera.target.y=map.image.height/2-(cell.y+.5)*map.tilesize}function renderRange(range,sprites){var tilewidth=sprites.squares.move.width,tileheight=sprites.squares.move.height,result=create((range.center.x+range.radius+1)*tilewidth,(range.center.y+range.radius+1)*tileheight),_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _iterator5=range.squares[Symbol.iterator]();!(_iteratorNormalCompletion5=(sprite=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var square=sprite.value,_x5=square.cell.x*tilewidth,_y5=square.cell.y*tileheight,sprite=sprites.squares.move;"attack"===square.type&&(sprite=sprites.squares.attack),result.drawImage(sprite,_x5,_y5)}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}return result.canvas}function create$g(range,sprites){return{id:"Range",data:range,anim:create$3(range),image:renderRange(range,sprites),sprites:sprites,exit:!1,blocking:!0}}compRange=Object.freeze({__proto__:null,create:create$g,exit:function(range){range.exit=!0,range.anim&&(range.anim.done=!0),range.anim=create$4(range.data)},render:function(range,screen){var image=range.image,anim=range.anim;if(anim)image=renderRange(anim.range,range.sprites);else if(range.exit)return[];return[{image:image,layer:"range",x:screen.camera.origin.x,y:screen.camera.origin.y}]}});function renderNameTag(name,tag,x){var fonts=x.fonts,text=x.palette,text=renderText(name,{font:fonts.standard,shadow:text.jet}),tag=function(width,height,faction,sprites){var palette=sprites.tag[faction].palette,tag=create(width+1,height+1);return tag.fillStyle=rgb.apply(void 0,_toConsumableArray(palette[0])),tag.fillRect(2,0,width-2,1),tag.fillStyle=rgb.apply(void 0,_toConsumableArray(palette[1])),tag.fillRect(2,1,width-2,height-1),tag.fillStyle=rgb.apply(void 0,_toConsumableArray(palette[2])),tag.fillRect(2,height,width-2,1),tag.drawImage(sprites.tag[faction].start,0,0),tag.drawImage(sprites.tag[faction].end,width-2,0),tag.canvas}(52,2+text.height-3+2,tag,x).getContext("2d"),x=Math.ceil(26-(text.width-1)/2);return tag.drawImage(text,x,2),tag.canvas}function renderBox(width,height,box){var palette=box.palette,box=create(width+2,height+2);return box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.brown)),box.fillRect(0,1,width+2,height),box.fillRect(1,0,width,height+2),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.taupe)),box.fillRect(0,1,width+1,height-1),box.fillRect(1,0,width-1,height+1),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.beige)),box.fillRect(0,1,width,height-2),box.fillRect(1,0,width-2,height),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.taupe)),box.fillRect(2,1,width-4,height-2),box.fillRect(1,2,width-2,height-4),box.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.beige)),box.fillRect(2,2,width-4,height-4),box.canvas}function getGradient(hp,end,palette,reverse){var start=palette.hp.opal;"enemy"===end?start=palette.hp.red:"ally"===end&&(start=palette.lime);end=palette.maroon;return 15===hp?end=palette.hp.indigo:12<=hp?end=palette.hp.blue:9<=hp?end=palette.hp.green:7<=hp?end=palette.hp.yellow:4<=hp&&(end=palette.hp.orange),reverse?[end,start]:[start,end]}function earlyExit(duration,t){return t/(1/duration)}var corners=["bottomleft","bottomright","topleft","topright"];function onresize(preview,viewport){160<=viewport.width?"topright"===preview.corner&&(preview.corner="bottomright"):"bottomright"===preview.corner&&(preview.corner="topright")}var compPreview=Object.freeze({__proto__:null,create:function(unit,corner,image){if(!corners.includes(corner))throw new Error("Failed to create preview component: "+corner+" is not a valid corner identifier");return{id:"Preview",anim:create$d(15,{src:-(image=function(unit,sprites){var fonts=sprites.fonts,palette=sprites.palette,tag=renderNameTag(unit.name,unit.control.faction,sprites),x=function(){var content=create(68,29),label=sprites.labels.hp,shadowed=renderText(unit.hp+"/"+unit.stats.hp,{font:fonts.smallcapsRadiant}),health=create(48,3),shadow=Math.round((health.canvas.width-2)*unit.hp/unit.stats.hp),end=getGradient(unit.hp,unit.control.faction,palette),labelshadow=_slicedToArray(end,2),start=labelshadow[0],end=labelshadow[1],labelshadow=health.createLinearGradient(0,1,health.canvas.width-2,1);labelshadow.addColorStop(0,rgb.apply(void 0,_toConsumableArray(start))),labelshadow.addColorStop(1,rgb.apply(void 0,_toConsumableArray(end))),health.fillStyle=labelshadow,health.fillRect(2,0,shadow,1),health.fillRect(1,1,shadow,1),health.fillRect(0,2,shadow,1),content.drawImage(label,2,0);labelshadow=recolor$1(content.canvas,palette.taupe);content.drawImage(shadowed,2+label.width+4,2);shadow=recolor$1(content.canvas,palette.taupe);content.drawImage(shadow,1,1),content.drawImage(labelshadow,1,1),content.drawImage(sprites.bars.small,2+label.width,0),content.drawImage(health.canvas,2+label.width+1,1),content.drawImage(label,2,0),content.drawImage(shadowed,2+label.width+4,2);shadowed=function(badge){var stats=create(badge,11);stats.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.cream)),stats.fillRect(1,0,badge-2,11),stats.fillRect(0,1,badge,9);var shadowed=create(badge-6,9),stat=unit.stats.atk,value="mage"===unit.type?unit.stats.element:unit.wpn.type,badge=sprites.badges[value],value=renderText(stat,{font:fonts.numbers,color:palette.jet});shadowed.drawImage(badge,0,0),shadowed.drawImage(value,0+badge.width+2,1),stat=unit.stats.hit,badge=sprites.badges.target,value=renderText(stat,{font:fonts.numbers,color:palette.jet}),shadowed.drawImage(badge,21,0),shadowed.drawImage(value,21+badge.width+2,1),stat=unit.stats.spd,badge=sprites.badges.wing,unit.stats.def>unit.stats.spd&&(stat=unit.stats.def,badge=sprites.badges.shield),value=renderText(stat,{font:fonts.numbers,color:palette.jet}),shadowed.drawImage(badge,42,0),shadowed.drawImage(value,42+badge.width+2,1);shadowed=drawShadow(shadowed.canvas,palette.sage);return stats.drawImage(shadowed,3,1),stats.canvas}(content.canvas.width-4);content.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.taupe)),content.fillRect(2,label.height+3,content.canvas.width-4,1);shadowed=drawShadow(shadowed,palette.sage);return content.drawImage(shadowed,2,label.height+6),content.canvas}(),shadow=renderBox(76,x.height+8,sprites).getContext("2d"),preview=create(shadow.canvas.width,shadow.canvas.height+9);return shadow.drawImage(x,4,6),preview.drawImage(shadow.canvas,0,9),x=Math.ceil(37-(tag.width-1)/2),shadow=recolor$1(tag,palette.taupe),preview.drawImage(shadow,x,1),preview.drawImage(tag,x,0),preview.canvas}(unit,image)).width,dest:2}),unit:unit,corner:corner,image:image,blocking:!0,exit:!1,renders:0}},exit:function(preview){var src=preview.anim?preview.anim.x:1,duration=preview.anim?earlyExit(5,preview.anim.x):5;preview.anim=create$e(duration,{src:src,dest:0}),preview.exit=!0},onresize:onresize,render:function(preview,screen){var x=preview.anim,image=preview.image;preview.renders||onresize(preview,screen.camera),preview.renders++;var start=void 0,y=void 0;return preview.corner.endsWith("left")?(start=-image.width,y=2):preview.corner.endsWith("right")&&(start=screen.camera.width+preview.image.width,y=screen.camera.width-preview.image.width-2+1),x=x?lerp_1(start,y,x.x):y,y=2,preview.corner.startsWith("bottom")&&(y=screen.camera.height-image.height-2+1),[{layer:"ui",image:image,x:x,y:y}]}}),enterDuration$1=15;function create$i(sprites){return{id:"Vs",anim:create$d(enterDuration$1),image:sprites.vs,persist:!0,blocking:!0,exit:!1}}compVs=Object.freeze({__proto__:null,create:create$i,exit:function(vs){var src=vs.anim?vs.anim.x:1,duration=vs.anim?earlyExit(7,vs.anim.x):7;vs.anim=create$e(duration,{src:src,dest:0}),vs.exit=!0},render:function(y,width){var anim=y.anim,image=y.image,x=width.camera.width/2,y=width.camera.height-64,width=image.width;return anim&&(width*=anim.x),[{layer:"ui",origin:"center",image:image,x:x,y:y,width:width}]}});var RenderHP=Object.freeze({__proto__:null,maxwidth:54,left:function(end,width,gradient,hp){var x=hp.bars,start=hp.palette,hp=copy(x.left),x=end/width,x=5+(54-(width=Math.round(54*x))),end=getGradient(end,gradient,start,!0),start=(gradient=_slicedToArray(end,2))[0],end=gradient[1];return(gradient=hp.createLinearGradient(x,0,x+width,0)).addColorStop(0,rgb.apply(void 0,_toConsumableArray(start))),gradient.addColorStop(1,rgb.apply(void 0,_toConsumableArray(end))),hp.fillStyle=gradient,hp.fillRect(2+x,2,width,2),hp.fillRect(1+x,4,width,2),hp.fillRect(x,6,width,1),hp.canvas},leftChunk:function(chunkwidth,value,x,chunk,color){return chunk=create((chunk=chunk.bars.left).width,chunk.height),chunkwidth=Math.round(chunkwidth/x*54),x=value/x*54,x=Math.round(54-chunkwidth-x),chunk.fillStyle=color||"white",chunk.fillRect(7+x,2,chunkwidth,2),chunk.fillRect(6+x,4,chunkwidth,2),chunk.fillRect(5+x,6,chunkwidth,1),chunk.canvas},right:function(end,width,gradient,start){var hp=start.bars,start=start.palette,hp=copy(hp.right),width=end/width,width=Math.round(54*width),end=getGradient(end,gradient,start),start=(gradient=_slicedToArray(end,2))[0],end=gradient[1];return(gradient=hp.createLinearGradient(9,0,9+width,0)).addColorStop(0,rgb.apply(void 0,_toConsumableArray(start))),gradient.addColorStop(1,rgb.apply(void 0,_toConsumableArray(end))),hp.fillStyle=gradient,hp.fillRect(6,2,width,2),hp.fillRect(7,4,width,2),hp.fillRect(8,6,width,1),hp.canvas},rightChunk:function(chunkwidth,value,x,chunk,color){return chunk=create((chunk=chunk.bars.right).width,chunk.height),chunkwidth=Math.round(chunkwidth/x*54),x=Math.round(value/x*54),chunk.fillStyle=color||"white",chunk.fillRect(6+x,2,chunkwidth,2),chunk.fillRect(7+x,4,chunkwidth,2),chunk.fillRect(8+x,6,chunkwidth,1),chunk.canvas}}),enterDuration$2=15;function create$j(value,max,faction,opts){return{id:"Hp",value:value,max:max,faction:faction,opts:Object.assign({flipped:!1},opts),anim:create$d(enterDuration$2),mode:{type:"static"},persist:!0,blocking:!0,init:!1,exit:!1,cache:{image:null,full:null,damaged:null,chunk:null}}}function endReduce(hp){hp.cache.image=hp.cache.damaged,hp.value-=hp.mode.damage,hp.mode={type:"static"}}function startFlash(hp,damage){hp.mode={type:"flash",damage:Math.min(hp.value,damage)}}var compHp=Object.freeze({__proto__:null,create:create$j,exit:function(hp){var src=hp.anim?hp.anim.x:1,duration=hp.anim?earlyExit(7,hp.anim.x):7;hp.anim=create$e(duration,{src:src,dest:0}),hp.exit=!0},onupdate:function(hp){var anim=hp.mode.anim;anim&&(anim.done?endReduce(hp):update$b(anim))},startReduce:function(hp,damage){hp.mode={type:"reduce",anim:create$e(20,{delay:10}),damage:Math.min(hp.value,damage)}},endReduce:endReduce,startFlash:startFlash,render:function(hp,_value){var nodes=[],value=_value.view.viewport,sprites=_value.view.sprites,inval=sprites.palette,side=hp.opts.flipped?"right":"left",origin="topright",image=0,damage=value.width/2-10;"right"==side&&(origin="topleft",image=value.width,damage=value.width/2+10);var _chunk,chunk=hp.anim,x=chunk?lerp_1(image,damage,chunk.x):damage,y=value.height-64;return(image=hp.cache.image)||(image=RenderHP[side](hp.value,hp.max,hp.faction,sprites),hp.cache.image=image,hp.cache.full=image),"flash"===hp.mode.type&&((chunk=hp.cache.chunk)||(damage=Math.min(hp.mode.damage,hp.value),value=hp.value-damage,_chunk=hp.max,chunk=hp.cache.chunk=RenderHP[side+"Chunk"](damage,value,_chunk,sprites)),_chunk=_value.time%75/75,_chunk=(Math.sin(2*Math.PI*_chunk)+1)/2*.75+.25,_value.dirty=!0,nodes.push({layer:"ui",image:chunk,x:x,y:y,origin:origin,opacity:_chunk})),"reduce"===hp.mode.type&&hp.mode.anim&&(_chunk=_value.time%2?rgb.apply(void 0,_toConsumableArray(inval.red)):rgb.apply(void 0,_toConsumableArray(inval.white)),_value=lerp_1(hp.mode.damage,0,hp.mode.anim.x),inval=lerp_1(0,hp.mode.damage,hp.mode.anim.x),_chunk=RenderHP[side+"Chunk"](_value,hp.value-hp.mode.damage,hp.max,sprites,_chunk),image=hp.cache.damaged=RenderHP[side](hp.value-inval,hp.max,hp.faction,sprites),nodes.push({layer:"ui",image:_chunk,x:x,y:y,origin:origin})),nodes.unshift({layer:"ui",image:image,x:x,y:y,origin:origin}),nodes}}),enterDuration$3=15;function create$k(name,faction,sprites,defending){return{id:"Tag",anim:create$d(enterDuration$3),image:renderNameTag(name,faction,sprites),flipped:!!defending,persist:!0,blocking:!0,exit:!1}}var eileen=Object.freeze({__proto__:null,create:create$k,exit:function(tag){var src=tag.anim?tag.anim.x:1,duration=tag.anim?earlyExit(7,tag.anim.x):7;tag.anim=create$e(duration,{src:src,dest:0}),tag.exit=!0},render:function(tag,screen){var anim=tag.anim,image=tag.image,origin="bottomright",start=0,goal=screen.camera.width/2-20;return tag.flipped&&(origin="bottomleft",start=screen.camera.width,goal=screen.camera.width/2+20),[{layer:"ui",image:image,x:anim?lerp_1(start,goal,anim.x):goal,y:screen.camera.height-64,origin:origin}]}}),tiles={" ":{id:"floor",walkable:!0},"#":{id:"wall",walkable:!1}};function at(map,cell){return contains(map,cell)?map.layout[cell.y*map.width+cell.x]:null}function contains(map,cell){return 0<=cell.x&&0<=cell.y&&cell.x<map.width&&cell.y<map.height}function walkable(map,cell){return contains(map,cell)&&at(map,cell).walkable}function unitAt(map,cell){if(contains(map,cell)){var _iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _iterator6=map.units[Symbol.iterator]();!(_iteratorNormalCompletion6=(unit=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var unit=unit.value;if(equals(unit.cell,cell))return unit}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}}}function remove(map,u){u=map.units.indexOf(u);return-1!==u&&(map.units.splice(u,1),1)}var weapons={sword:{type:"sword",stat:"str",atk:2,hit:0,rng:{start:1,end:1},pierce:!0},axe:{type:"axe",stat:"str",atk:2,hit:-2,rng:{start:1,end:1},pierce:!0},lance:{type:"lance",stat:"str",atk:1,hit:1,rng:{start:1,end:1},pierce:!0},dagger:{type:"dagger",stat:"str",atk:1,hit:0,rng:{start:1,end:1},pierce:!1},bow:{type:"bow",stat:"str",atk:1,hit:2,rng:{start:2,end:2},pierce:!1},tome:{type:"tome",stat:"mag",atk:1,hit:0,rng:{start:1,end:2},pierce:!1}},typeWeapons={soldier:"sword",fighter:"axe",knight:"lance",thief:"dagger",archer:"bow",mage:"tome"},inRange=function(number,end){var start=end.start,start=void 0===start?0:start,end=end.end;if("number"!=typeof number||"number"!=typeof start||"number"!=typeof end)throw new TypeError("Expected all arguments to be numbers");return number>=Math.min(start,end)&&number<=Math.max(end,start)};function create$m(name,type,control,stats,cell){return stats=Object.assign({mov:5},stats),"knight"===type?stats.mov=4:"thief"===type&&(stats.mov=6),{name:name,type:type,control:control,cell:cell,stats:stats,hp:stats.hp,wpn:function(type){return weapons[typeWeapons[type]]}(type)}}function attack(unit,target,opts){if((opts=Object.assign({},opts)).data||(opts.data=attackData(unit,target)),!opts.data)return null;var attack=opts.data;return target.hp-=attack.realdmg,attack.counter&&(unit.hp-=attack.counter.realdmg),target.hp<=0?(opts.map&&remove(opts.map,target),target):unit.hp<=0?(opts.map&&remove(opts.map,unit),unit):null}function allied(a,b){return(a=a.control.faction)===(b=b.control.faction)||"player"===a&&"ally"===b||"ally"===a&&"player"===b}function inRange$1(unit,steps$1){var range=unit.wpn.rng,steps$1=steps(unit.cell,steps$1);return inRange(steps$1,range)}function findDmg(unit,target){var dmg=unit.stats.atk;return"mag"===unit.wpn.stat?dmg-=target.stats.res:"str"===unit.wpn.stat&&"fighter"!==unit.type&&(dmg-=target.stats.def),dmg<0&&(dmg=0),dmg}function canDouble(unit,target){return 3<=unit.stats.spd-target.stats.spd}function attackData(unit,target){if(!inRange$1(unit,target.cell))return null;var hit=Math.max(0,unit.stats.hit-target.stats.spd),dmg=hit?findDmg(unit,target):0,realdmg=Math.min(dmg,target.hp);if(dmg>=target.hp)return{source:unit,target:target,hit:hit,dmg:dmg,realdmg:realdmg,doubles:!1,finishes:!0};var counter=null;inRange$1(target,unit.cell)&&(counter={source:target,target:unit,hit:finishes=Math.max(0,target.stats.hit-unit.stats.spd),dmg:doubles=finishes?findDmg(target,unit):0,realdmg:Math.min(doubles,unit.hp),finishes:!1,doubles:!1},canDouble(target,unit)&&counter.dmg<unit.hp&&(counter.realdmg=Math.min(2*counter.dmg,unit.hp),counter.finishes=counter.realdmg>=unit.hp,counter.doubles=!0));var finishes=!1,doubles=!1;return canDouble(unit,target)&&(!counter||counter.dmg<unit.hp)&&(finishes=(realdmg=Math.min(2*dmg,target.hp))>=target.hp,doubles=!0),{source:unit,target:target,hit:hit,dmg:dmg,realdmg:realdmg,doubles:doubles,finishes:finishes,counter:counter}}function renderPanel(text,atkVal,val2,panel){var ctrVal=panel.palette,fonts=panel.fonts,panel=renderBase(text,panel).getContext("2d"),ctrVal={font:fonts.smallcapsBold,color:ctrVal.jet,shadow:ctrVal.sage},atkVal=renderText(atkVal,ctrVal),ctrVal=renderText(val2,ctrVal);return panel.drawImage(atkVal,8-Math.floor(atkVal.width/2),3),panel.drawImage(ctrVal,55-Math.floor(ctrVal.width/2),3),panel.canvas}function renderBase(text,base){var palette=base.palette,label=base.fonts,base=create(64,12),label=renderText(text,{font:label.smallcapsBold,shadow:palette.jet});return base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.sage)),base.fillRect(1,0,62,12),base.fillRect(0,1,64,10),base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.cream)),base.fillRect(1,0,61,11),base.fillRect(0,1,63,9),base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.jet)),base.fillRect(17,0,30,12),base.fillRect(16,1,32,10),base.fillStyle=rgb.apply(void 0,_toConsumableArray(palette.brown)),base.fillRect(17,0,29,11),base.fillRect(16,1,31,9),base.drawImage(label,21,3),base.canvas}var enterDuration$4=15,offsetDelay=5;function create$n(type,attack,double,opts){opts=Object.assign({offset:0},opts);var image=null;if("wpn"===type){var atkwpn=attack.source.wpn.type,ctrwpn=attack.target.wpn.type;"mage"===attack.source.type&&(atkwpn=attack.source.stats.element),"mage"===attack.target.type&&(ctrwpn=attack.target.stats.element),image=function(atkwpn,ctrwpn,sprites){var palette=sprites.palette,panel=renderBase("WPN",sprites).getContext("2d"),badges=create(panel.canvas.width,panel.canvas.height);return badges.drawImage(sprites.badges[atkwpn],4,1),badges.drawImage(sprites.badges[ctrwpn],51,1),panel.drawImage(drawShadow(badges.canvas,palette.sage),0,0),panel.canvas}(atkwpn,ctrwpn,double)}else if("dmg"===type)image=function(atkdmg,ctrdmg,sprites){return renderPanel("DMG",atkdmg,ctrdmg,sprites)}(attack.hit?attack.dmg:"-",attack.counter&&attack.counter.hit?attack.counter.dmg:"-",double);else{if("hit"!==type)throw new Error("Failed to render statpanel component: type "+type+" is not defined");image=function(atkhit,ctrhit,sprites){return renderPanel("HIT",atkhit,ctrhit,sprites)}(attack.hit,attack.counter?attack.counter.hit:"-",double)}double=null;return"dmg"===type&&attack.doubles&&attack.dmg?double="attacker":"dmg"===type&&attack.counter&&attack.counter.doubles&&attack.counter.dmg&&(double="defender"),{id:"StatPanel",anim:create$d(enterDuration$4,{delay:opts.offset*offsetDelay}),image:image,opts:opts,double:double,blocking:!0,exit:!1}}var goblin1=Object.freeze({__proto__:null,create:create$n,exit:function(panel){var opts=panel.anim?panel.anim.x:1,duration=panel.anim?earlyExit(7,panel.anim.x):7,opts={src:opts,dest:0,delay:panel.opts.offset*offsetDelay};panel.anim=create$e(duration,opts),panel.exit=!0},render:function(_y7,_d2){var _image2,_x7,nodes=[],_height=_y7.anim,width=_y7.image,parent={layer:"ui",origin:"center",image:width,x:_d2.camera.width/2,y:_d2.camera.height-64+28+13*_y7.opts.offset,height:_height?width.height*_height.x:width.height};return nodes.push(parent),_y7.double&&(_x7="attacker"===_y7.double?-1:1,_image2=_d2.view.sprites.x2,width=_height?_image2.width*_height.x:_image2.width,_height=_height?_image2.height*_height.x:_image2.height,_x7=parent.x+(_y7.image.width/2+4)*_x7,_y7=parent.y-_y7.image.height/2,_d2=_d2.time%60/60,_x7+=2*Math.cos(2*Math.PI*_d2),_y7+=2*Math.sin(2*Math.PI*_d2),nodes.push({layer:"ui",origin:"center",image:_image2,x:_x7,y:_y7,width:width,height:_height})),nodes}}),exitDuration$5=7;function exit$6(log){var src=log.anim?log.anim.x:1,duration=log.anim?earlyExit(exitDuration$5,log.anim.x):exitDuration$5;log.anim=create$e(duration,{src:src,dest:0}),log.exit=!0}troll2=Object.freeze({__proto__:null,create:function(){return{id:"Log",messages:[],anim:create$d(15,{delay:10}),pos:{col:0,row:0,offset:0},updated:!1,box:null,surface:null,persist:!0,blocking:!1,exit:!1,cache:[]}},exit:exit$6,append:function(log,message){console.log(message),log.messages.push(message),log.updated&&(log.pos.row++,log.pos.col=0,log.updated=!1)},onresize:function(){},onupdate:function(log,screen){180<=screen.time-log.time&&!log.exit&&exit$6(log)},render:function(log,start){var nodes=[],y=start.view.viewport,sprites=start.view.sprites,width=sprites.palette,font=sprites.fonts.standard,text={font:font,color:width.jet,shadow:width.taupe};log.box||(width=y.width-4,log.box=renderBox(width,40,sprites)),log.surface||(anim=y.width-4-16,image=log.box.height-20+4,log.surface=create(anim,image));var surface=log.surface;surface.clearRect(0,0,surface.canvas.width,surface.canvas.height);var line,pos=log.pos,anim=log.messages[pos.row],image=log.cache[pos.row];!anim||log.updated||image&&image.done||(image||(line=create(surface.canvas.width,font.data.cellsize.height),log.cache[pos.row]=image={canvas:line.canvas,x:0,done:!1}),line=image.canvas.getContext("2d"),text=renderText(anim[pos.col],text),line.drawImage(text,image.x,0),image.x+=text.width,pos.col<anim.length-1?pos.col++:pos.row<log.messages.length-1?(pos.row++,pos.col=0,image.done=!0):log.updated=!0,log.time=start.time,start.dirty=!0),2<=pos.row&&(pos.offset+=(pos.row-1-pos.offset)/8);for(var i=0;i<log.cache.length;i++){var _line2=log.cache[i],_y8=font.data.cellsize.height+font.data.spacing.line;_line2||console.log(log.cache);_y8=Math.round((i-pos.offset)*_y8);surface.drawImage(_line2.canvas,0,_y8)}return anim=log.anim,image=log.box,start=y.height+image.height,y=y.height-2+1,y=anim?lerp_1(start,y,anim.x):y,nodes.push({layer:"ui",origin:"bottomleft",image:image,x:1,y:y}),nodes.push({layer:"ui",origin:"bottomleft",image:surface.canvas,x:9,y:y-7}),nodes}});function bbox(y){var width=y.width,height=y.height;if(0===width||0===height)return null;if(width=width||y.image.width,height=height||y.image.height,0===width||0===height)return null;var origin=y.origin||"topleft";"top"===origin?origin="topcenter":"right"===origin?origin="centerright":"bottom"===origin?origin="bottomcenter":"left"===origin&&(origin="centerleft");var x=y.x||0,y=y.y-(y.z||0)||0;return origin.startsWith("center")?y-=height/2:origin.startsWith("bottom")&&(y-=height),origin.endsWith("center")?x-=width/2:origin.endsWith("right")&&(x-=width),{left:x,top:y,right:x+width,bottom:y+height,width:width,height:height}}var enterDuration$6=15;function create$p(sprites,opts){return{id:"Back",anim:create$d(enterDuration$6),image:sprites.buttons.back,events:[],bbox:null,blocking:!0,exit:!1}}var irving=Object.freeze({__proto__:null,create:create$p,exit:function(button){var src=button.anim?button.anim.x:1,duration=button.anim?earlyExit(7,button.anim.x):7;button.anim=create$e(duration,{src:src,dest:0}),button.exit=!0},onclick:function(button,screen){button.events.push(["cancel",screen.mode.unit]),screen.commands.push({type:"cancel",unit:screen.mode.unit}),console.log(button.id)},render:function(button,node){var anim=button.anim,image=button.image,start=-image.width,node={layer:"ui",image:image,x:anim?lerp_1(start,4,anim.x):4,y:node.camera.height-4,origin:"bottomleft"};return anim||(button.bbox=bbox(node)),[node]}}),Range=getAugmentedNamespace(compRange),Preview=getAugmentedNamespace(compPreview),Vs=getAugmentedNamespace(compVs),Hp=getAugmentedNamespace(compHp),Tag=getAugmentedNamespace(eileen),eileen=getAugmentedNamespace(goblin1),Log=getAugmentedNamespace(troll2),goblin1=getAugmentedNamespace(irving),troll2={Range:Range,Preview:Preview,Vs:Vs,Hp:Hp,Tag:Tag,StatPanel:eileen,Log:Log,Back:goblin1},Comps=Object.freeze(Object.assign(Object.create(null),troll2,{default:troll2,Range:Range,Preview:Preview,Vs:Vs,Hp:Hp,Tag:Tag,StatPanel:eileen,Log:Log,Back:goblin1}));function getCell(realpos_y,map,cornerpos_y){var cornerpos_x=realpos_y.x/cornerpos_y.zoom-cornerpos_y.width/2,realpos_y=realpos_y.y/cornerpos_y.zoom-cornerpos_y.height/2,cornerpos_x=cornerpos_x+map.width*map.tilesize/2-cornerpos_y.pos.x,cornerpos_y=realpos_y+map.height*map.tilesize/2-cornerpos_y.pos.y;return{x:Math.floor(cornerpos_x/map.tilesize),y:Math.floor(cornerpos_y/map.tilesize)}}function select(mode,unit,held){mode.commands.push({type:"select",data:{unit:unit,held:held}})}irving=Object.freeze({__proto__:null,create:function(){return{id:"Home",comps:[],commands:[],anims:[],press:null}},onpress:function(mode,_iteratorError7,_didIteratorError7){if(_didIteratorError7=getCell(_didIteratorError7.pos,_iteratorError7.map,_iteratorError7.camera),(_didIteratorError7=unitAt(_iteratorError7.map,_didIteratorError7))&&(mode.press={unit:_didIteratorError7,time:_iteratorError7.time}),mode.comps.length){var _iteratorNormalCompletion7=!0,_didIteratorError7=!1,_iteratorError7=void 0;try{for(var _iterator7=mode.comps[Symbol.iterator]();!(_iteratorNormalCompletion7=(comp=_iterator7.next()).done);_iteratorNormalCompletion7=!0){var comp=comp.value;Comps[comp.id].exit(comp)}}catch(err){_didIteratorError7=!0,_iteratorError7=err}finally{try{!_iteratorNormalCompletion7&&_iterator7.return&&_iterator7.return()}finally{if(_didIteratorError7)throw _iteratorError7}}}},onmove:function(mode,screen,pointer){mode.press&&"click"!==pointer.mode&&(mode.press=null),"player"===screen.data.phase.faction&&pan(screen.camera,screen.map,pointer)},onrelease:function(mode,screen,cell){"player"===screen.data.phase.faction&&mode.press&&"click"===cell.mode?select(mode,mode.press.unit):(cell=getCell(cell.pos,screen.map,screen.camera),contains(screen.map,cell)&&console.log(cell)),mode.press=null},onupdate:function(mode,screen){var press=mode.press;press&&press.time&&20<=screen.time-press.time&&select(mode,mode.press.unit,!0)}});function neighborhood(cell,rng){for(var cells=[],ry=(rng.end,-rng.end);ry<=rng.end;ry++)for(var rx=-rng.end;rx<=rng.end;rx++){var _steps=Math.abs(rx)+Math.abs(ry);_steps<rng.start||_steps>rng.end||cells.push({x:cell.x+rx,y:cell.y+ry})}return cells}function strify(cell){return cell.x+","+cell.y}function pathfind(start,goal,opts){var path=[],open=[start],opened={},closed={},parent={},g={},f={};if(opts.width&&opts.height)for(var y=0;y<opts.height;y++)for(var x=0;x<opts.width;x++)g[x+","+y]=1/0,f[x+","+y]=1/0;for(g[strify(start)]=0,f[strify(start)]=steps(start,goal);open.length;){for(var cell,best={score:1/0,index:-1,cell:null},i=0;i<open.length;i++){(score=f[strify(cell=open[i])])<best.score&&(best.score=score,best.index=i,best.cell=cell)}if(equals(cell=best.cell,goal)){for(;!equals(cell,start);)path.unshift(cell),cell=parent[strify(cell)];return path.unshift(cell),path}open.splice(best.index,1),opened[strify(cell)]=!1,closed[strify(cell)]=!0;for(var adj=neighbors(cell),i=0;i<adj.length;i++){var score,neighbor=adj[i];if(!closed[strify(neighbor)]&&!(opts&&opts.width&&opts.height&&(neighbor.x<0||neighbor.y<0||neighbor.x>=opts.width||neighbor.y>=opts.height))){if(opts&&opts.blacklist){for(var j=0;j<opts.blacklist.length;j++){if(equals(opts.blacklist[j],neighbor))break}if(j<opts.blacklist.length)continue}opened[strify(neighbor)]||(opened[strify(neighbor)]=!0,open.push(neighbor)),(score=g[strify(cell)]+1)>=g[strify(neighbor)]||(parent[strify(neighbor)]=cell,g[strify(neighbor)]=score,f[strify(neighbor)]=score+steps(neighbor,goal))}}}return[]}function unwalkables(map,unit){for(var unwalkables=[],_y9=map.height;_y9--;)for(var _x8=map.width;_x8--;)(function(_x8){var cell={x:_x8,y:_y9};if(!at(map,cell).walkable)return unwalkables.push(cell);map.units.find(function(other){return equals(other.cell,cell)&&!equals(other.cell,unit.cell)&&!allied(unit,other)})&&unwalkables.push(cell)})(_x8);return unwalkables}function pathfind$1(unit,dest,opts,cache){var path=null,opts={width:opts.width,height:opts.height,blacklist:unwalkables(opts,unit)};if(cache){for(var cpath=cache,apath=pathfind(cpath[cpath.length-1],dest,opts),i=apath.length;1<=--i;){for(var j=0;j<cpath.length;j++)if(equals(apath[i],cpath[j])){path=cpath.slice(0,j).concat(apath.slice(i));break}if(path)break}path||cpath.length+apath.length-2<=unit.stats.mov&&(path=cpath.concat(apath.slice(1)))}return path=path||pathfind(unit.cell,dest,opts)}function findRange(unit,map){var mov=unit.stats.mov,rng=unit.wpn.rng,_iteratorError9=mov+rng.end,range={center:unit.cell,radius:_iteratorError9,squares:[],edges:[]},queue=[{steps:0,cell:unit.cell}],edges=[];for(mov||(queue.length=0,edges.push(unit.cell));queue.length;){var node=queue.shift(),_iteratorNormalCompletion8=!0,_didIteratorError8=!1,_iteratorError8=void 0;try{for(var _step8,_iterator8=neighbors(node.cell)[Symbol.iterator]();!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=!0)(function(neighbor){if(!walkable(map,neighbor,node.cell))return;if(range.squares.find(function(square){return"move"===square.type&&equals(neighbor,square.cell)}))return;var target=unitAt(map,neighbor);target?allied(unit,target)||range.squares.find(function(square){return"attack"===square.type&&equals(neighbor,square.cell)})||range.squares.push({type:"attack",cell:neighbor,target:target}):range.squares.push({type:"move",cell:neighbor}),node.steps+1<mov&&(target&&!allied(unit,target)||queue.push({steps:node.steps+1,cell:neighbor})),node.steps>=mov-rng.end&&(target&&!allied(unit,target)||edges.push(neighbor))})(_step8.value)}catch(err){_didIteratorError8=!0,_iteratorError8=err}finally{try{!_iteratorNormalCompletion8&&_iterator8.return&&_iterator8.return()}finally{if(_didIteratorError8)throw _iteratorError8}}}var _iteratorNormalCompletion9=!0,_didIteratorError9=!1,_iteratorError9=void 0;try{for(var _iterator9=edges[Symbol.iterator]();!(_iteratorNormalCompletion9=(_iteratorError10=_iterator9.next()).done);_iteratorNormalCompletion9=!0){var edge=_iteratorError10.value,_iteratorNormalCompletion10=!0,_didIteratorError10=!1,_iteratorError10=void 0;try{for(var _step10,_iterator10=neighborhood(edge,rng)[Symbol.iterator]();!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=!0)(function(_neighbor){if(!contains(map,_neighbor)||!walkable(map,_neighbor)||equals(unit.cell,_neighbor))return;var target=unitAt(map,_neighbor);if(!target||!allied(unit,target)){if(range.squares.find(function(square){return equals(_neighbor,square.cell)}))return;range.squares.push({type:"attack",cell:_neighbor,target:target})}})(_step10.value)}catch(err){_didIteratorError10=!0,_iteratorError10=err}finally{try{!_iteratorNormalCompletion10&&_iterator10.return&&_iterator10.return()}finally{if(_didIteratorError10)throw _iteratorError10}}}}catch(err){_didIteratorError9=!0,_iteratorError9=err}finally{try{!_iteratorNormalCompletion9&&_iterator9.return&&_iterator9.return()}finally{if(_didIteratorError9)throw _iteratorError9}}return range}var tilesize=16;function hover(mode,cell){var pos=mode.map,unit=mode.unit,range=mode.range,sprites=mode.sprites,select=mode.select,cpath=select&&select.path,cdest=cpath?cpath[cpath.length-1]:null;if(cpath&&equals(cdest,cell)&&(!select.cursor||equals(select.cursor.target,cell)))return 1;var square,_unit,_rng,dest,path=null,target=select&&select.target;equals(unit.cell,cell)?path=[unit.cell]:(square=range.squares.find(function(square){return equals(square.cell,cell)&&("move"===square.type||"attack"===square.type&&square.target)}))&&(dest=cell,square.target&&!target&&(_unit=square.target,_rng=Preview.create(_unit,"topright",sprites),mode.comps.push(_rng),target={unit:_unit,preview:_rng}),!target||square.target&&target.unit===square.target||(Preview.exit(target.preview),target=null),!cpath&&square.target&&inRange$1(unit,cell)?path=[unit.cell]:(_rng=unit.wpn.rng,square.target&&(inRange(steps(cdest||unit.cell,cell),_rng)?cpath||(path=[unit.cell]):dest=neighborhood(dest,_rng).filter(function(cell){return range.squares.find(function(square){return"move"===square.type&&equals(square.cell,cell)})}).sort(function(a,b){return steps(a,unit.cell)-steps(b,unit.cell)})[0]),!path&&dest&&cpath&&(path=square.target&&inRange(steps(cdest,cell),_rng)?cpath:pathfind$1(unit,dest,pos,cpath))),path=path||pathfind$1(unit,dest,pos)),select||!path&&!target||(select=mode.select={cursor:null,path:null,arrow:null,valid:!1,target:null}),path?(mode.select.cursor?select.cursor.target=cell:(pos={x:cell.x*tilesize,y:cell.y*tilesize},select.cursor={pos:pos,target:cell,cached:pos}),select.valid=!0,select.arrow=sprites.Arrow(path,unit.control.faction),select.path=path):mode.select&&(select.valid=!1,select.cursor=null),target?select.target=target:select&&(select.target=null)}troll2=Object.freeze({__proto__:null,create:function(data){return{id:"Select",next:null,comps:[],commands:[],anims:[],anim:null,unit:data.unit,held:data.held,playable:!0,sprites:null,map:null,range:null,select:null}},onenter:function(mode,screen){var unit=mode.unit,cursor=findRange(unit,screen.map),range=Range.create(cursor,screen.view.sprites);mode.comps.push(range),mode.range=cursor,cursor=Preview.create(unit,"bottomleft",screen.view.sprites),mode.comps.push(cursor),mode.anim=create$7({unit:unit}),mode.anims.push(mode.anim),mode.sprites=screen.view.sprites,mode.map=screen.map,mode.playable=screen.data.phase.pending.includes(unit),mode.held?(cursor=getCell(screen.view.pointer.pos,screen.map,screen.camera))&&hover(mode,cursor):center(screen.camera,screen.map,unit.cell)},onexit:function(mode,screen){mode.anim&&"PieceLift"===mode.anim.id&&!mode.anim.done&&(mode.anim.done=!0,mode.anim=create$8({y:mode.anim.y,unit:mode.unit}),mode.anims.push(mode.anim))},onresize:function(mode,viewport){var _iteratorNormalCompletion11=!0,_didIteratorError11=!1,_iteratorError11=void 0;try{for(var _iterator11=mode.comps[Symbol.iterator]();!(_iteratorNormalCompletion11=(_onresize=_iterator11.next()).done);_iteratorNormalCompletion11=!0){var comp=_onresize.value,_onresize=Comps[comp.id].onresize;_onresize&&_onresize(comp,viewport)}}catch(err){_didIteratorError11=!0,_iteratorError11=err}finally{try{!_iteratorNormalCompletion11&&_iterator11.return&&_iterator11.return()}finally{if(_didIteratorError11)throw _iteratorError11}}},onpress:function(mode,cursor,pointer){mode.anim&&mode.anim.blocking||(cursor=getCell(pointer.pos,cursor.map,cursor.camera))&&mode.playable&&hover(mode,cursor)},onmove:function(mode,screen,pointer){var cursor;mode.anim&&mode.anim.blocking||(mode.select?(cursor=getCell(pointer.pos,screen.map,screen.camera))&&mode.playable&&hover(mode,cursor):pan(screen.camera,screen.map,pointer))},onrelease:function(mode,screen,_target){var select,unit,path,dest;mode.anim&&mode.anim.blocking||(select=mode.select,unit=mode.unit,"click"!==_target.mode||mode.held||select?select&&select.valid?(dest=(path=select.path)[path.length-1],_target=select.target&&select.target.unit,equals(unit.cell,dest)?_target?mode.commands.push({type:"forecast",unit:unit,target:_target}):mode.commands.push({type:"endTurn",unit:unit}):function(mode,path,target){var unit=mode.comps.find(function(comp){return"Range"===comp.id});unit&&Range.exit(unit);{1<path.length?(unit=mode.unit,mode.anim.done=!0,mode.commands.push({type:"move",unit:unit,path:path}),target?mode.commands.push({type:"forecast",unit:unit,target:target}):mode.commands.push({type:"endTurn",unit:unit})):mode.commands.push({type:"cancel"})}}(mode,path,_target)):select&&function(mode){var target=mode.select&&mode.select.target;target&&Preview.exit(target.preview);mode.select=null}(mode):mode.commands.push({type:"cancel"}),mode.held=!1)},render:function(_x9,screen){var image,nodes=[],origin=screen.camera.origin,_y11=screen.view.pointer,_image3=screen.view.sprites,opacity=screen.view.viewport,select=_x9.select,_x10=_x9.unit,anim=_x9.anim,moving=screen.anims.find(function(anim){return"PieceMove"===anim.id}),selectvis=anim&&(!moving||screen.time%2);moving&&moving.done&&(_x9.select=null),selectvis&&screen.data.phase.pending.includes(_x10)&&(!screen.nextmode||_x9.anims.concat(screen.anims).find(function(anim){return"PieceDrop"===anim.id}))&&(image=_image3.select.ring[_x10.control.faction],_x9=origin.x+_x10.cell.x*screen.map.tilesize-2,cursor=origin.y+_x10.cell.y*screen.map.tilesize-2,nodes.push({layer:"ring",image:image,x:_x9,y:cursor}));var cursor=select&&select.arrow;return cursor&&selectvis&&nodes.push({layer:"arrow",image:cursor,x:origin.x,y:origin.y}),(cursor=select&&select.cursor)&&selectvis&&!equals(cursor.target,_x10.cell)&&nodes.push({layer:"cursor",image:_image3.select.cursor[_x10.control.faction],x:origin.x+cursor.pos.x-1,y:origin.y+cursor.pos.y-1}),!select||!anim||moving||cursor&&equals(cursor.target,_x10.cell)||(_image3=_image3.pieces[_x10.control.faction][_x10.type],_x10=_y11.pos.x/opacity.scale-_image3.width/2,_y11=_y11.pos.y/opacity.scale-_image3.height-8,opacity=.75,select.valid||(opacity=.25),nodes.push({layer:"mirage",image:_image3,x:_x10,y:_y11,opacity:opacity})),nodes},onupdate:function(cursor,screen){(cursor=cursor.select)&&cursor.cursor&&(cursor=cursor.cursor,Math.round(cursor.cached.x)===Math.round(cursor.pos.x)&&Math.round(cursor.cached.y)===Math.round(cursor.pos.y)||(cursor.cached.x=cursor.pos.x,cursor.cached.y=cursor.pos.y,screen.dirty=!0),cursor.pos.x+=(cursor.target.x*tilesize-cursor.pos.x)/4,cursor.pos.y+=(cursor.target.y*tilesize-cursor.pos.y)/4)}});eileen=Object.freeze({__proto__:null,create:function(data){return{id:"Forecast",unit:data.unit,target:data.target,attack:attackData(data.unit,data.target),comps:[],commands:[],anims:[],anim:null}},onenter:function(mode,screen){var unit,range=screen.view.sprites,atkr=mode.unit,midpoint=mode.target;if(!(unit=mode.attack))throw new Error("Failed to create attack data: Attempting to attack an enemy out of range. Reinforce range detection procedures before entering forecast mode.");console.log(unit);var dmg=create$k(atkr.name,atkr.control.faction,range),wpn=create$j(atkr.hp,atkr.stats.hp,atkr.control.faction);mode.comps.push(dmg),mode.comps.push(wpn),startFlash(wpn,unit.counter?unit.counter.realdmg:0),dmg=create$k(midpoint.name,midpoint.control.faction,range,{flipped:!0}),wpn=create$j(midpoint.hp,midpoint.stats.hp,midpoint.control.faction,{flipped:!0}),mode.comps.push(dmg),mode.comps.push(wpn),startFlash(wpn,unit.realdmg),dmg=create$i(range),mode.comps.push(dmg),wpn=create$n("wpn",unit,range),dmg=create$n("dmg",unit,range,{offset:1}),unit=create$n("hit",unit,range,{offset:2}),mode.comps.push(wpn),mode.comps.push(dmg),mode.comps.push(unit),unit=create$p(range),mode.comps.push(unit),range=create$g({center:atkr.cell,radius:"mage"===(unit=atkr).type||"archer"===unit.type?2:1,squares:neighborhood(atkr.cell,atkr.wpn.rng).map(function(cell){return{cell:cell,type:"attack"}})},range),mode.comps.push(range),mode.anim=create$7({unit:atkr}),mode.anims.push(mode.anim),midpoint={x:(atkr.cell.x+midpoint.cell.x)/2,y:(atkr.cell.y+midpoint.cell.y)/2},center(screen.camera,screen.map,midpoint),screen.camera.target.y-=screen.camera.height/4-6},onexit:function(mode,screen){var next=screen.nextmode;if(mode.anim&&"PieceLift"===mode.anim.id&&(mode.anim.done=!0),"Attack"===next.id)for(var persist=["Vs","Hp","Tag"],c=0;c<mode.comps.length;c++){var comp=mode.comps[c];persist.includes(comp.id)&&(mode.comps.splice(c--,1),next.comps.push(comp))}},onrelease:function(mode,screen,pointer){"click"===pointer.mode&&mode.commands.push({type:"attack",unit:mode.attack.source,attack:mode.attack})}});function init(attack,mode){var atkr=attack.data.source,defr=attack.data.target;attack.init=!0,mode.unit=atkr,mode.target=defr,mode.anim=create$a(atkr.cell,defr.cell,{unit:atkr}),mode.anims.push(mode.anim),attack.data.source===mode.data.source?(mode.atkrhp=mode.lhshp,mode.defrhp=mode.rhshp):(mode.atkrhp=mode.rhshp,mode.defrhp=mode.lhshp)}var goblin1=Object.freeze({__proto__:null,create:function(data){return{id:"Attack",comps:[],commands:[],attacks:[],anims:[],exit:!1,data:data.attack,unit:data.attack.source,target:data.attack.target,onend:data.onend,atkrhp:null,defrhp:null,lhshp:null,rhshp:null,log:null,anim:null}},onenter:function(mode,atktag){var _vs=atktag.view.sprites,deftag=mode.unit,defrhp=mode.target,_console=mode.data;if(!_console)throw new Error("Failed to create attack data: Attempting to attack an enemy out of range. Reinforce range detection procedures before entering attack mode.");var _iteratorNormalCompletion12=!0,_didIteratorError12=!1,atktag=void 0;try{for(var _iterator12=mode.comps[Symbol.iterator]();!(_iteratorNormalCompletion12=(comp=_iterator12.next()).done);_iteratorNormalCompletion12=!0){var comp=comp.value;"Hp"!==comp.id||comp.exit||(comp.mode="static",comp.opts.flipped?mode.rhshp=comp:mode.lhshp=comp)}}catch(err){_didIteratorError12=!0,atktag=err}finally{try{!_iteratorNormalCompletion12&&_iterator12.return&&_iterator12.return()}finally{if(_didIteratorError12)throw atktag}}mode.lhshp||mode.rhshp||(atktag=Tag.create(deftag.name,deftag.control.faction,_vs),deftag=Hp.create(deftag.hp,deftag.stats.hp,deftag.control.faction),mode.comps.push(atktag),mode.comps.push(deftag),mode.lhshp=deftag,deftag=Tag.create(defrhp.name,defrhp.control.faction,_vs,{flipped:!0}),defrhp=Hp.create(defrhp.hp,defrhp.stats.hp,defrhp.control.faction,{flipped:!0}),mode.comps.push(deftag),mode.comps.push(defrhp),mode.rhshp=defrhp,_vs=Vs.create(_vs),mode.comps.push(_vs)),mode.log=Log.create(),mode.comps.push(mode.log),mode.attacks.push({type:"init",data:_console}),_console.dmg<_console.target.hp&&_console.counter&&(mode.attacks.push({type:"counter",data:_console.counter}),_console.counter.dmg&&!_console.counter.finishes&&_console.counter.doubles&&mode.attacks.push({type:"double",data:_console.counter})),!(_console.dmg&&_console.dmg<_console.target.hp&&_console.doubles)||_console.counter&&_console.counter.finishes||mode.attacks.push({type:"double",data:_console}),init(mode.attacks[0],mode),(_console=console).log.apply(_console,["attacks"].concat(_toConsumableArray(mode.attacks))),console.log(mode.anim)},onexit:function(mode,screen){var _iteratorNormalCompletion13=!0,_didIteratorError13=!1,_iteratorError13=void 0;try{for(var _iterator13=mode.comps[Symbol.iterator]();!(_iteratorNormalCompletion13=(comp=_iterator13.next()).done);_iteratorNormalCompletion13=!0){var comp=comp.value;Comps[comp.id].exit(comp)}}catch(err){_didIteratorError13=!0,_iteratorError13=err}finally{try{!_iteratorNormalCompletion13&&_iterator13.return&&_iterator13.return()}finally{if(_didIteratorError13)throw _iteratorError13}}},onrelease:function(mode,screen,pointer){pointer.mode},onupdate:function(mode,screen){mode.anim,mode.cache,mode.unit,mode.target;var _atkr,_defr,flinch,duration,log=mode.log,camera=screen.camera,attack=mode.attacks[0];attack?(_atkr=attack.data.source,_defr=attack.data.target,duration=mode.anim,attack.time?duration&&duration.connect&&!attack.connect?(attack.connect=!0,Hp.startReduce(mode.defrhp,attack.data.dmg),attack.data.dmg&&(flinch=create$c(_defr.cell,_atkr.cell,{unit:_defr}),mode.anims.push(flinch)),"init"===attack.type?Log.append(log,_atkr.name+" attacks"):"counter"===attack.type?Log.append(log,_atkr.name+" counters"):"double"===attack.type&&Log.append(log,_atkr.name+" attacks again"),attack.data.hit?attack.data.dmg?allied(_defr,mode.data.source)?Log.append(log,_defr.name+" suffers "+attack.data.dmg+" damage."):allied(_defr,mode.data.source)||Log.append(log,_defr.name+" receives "+attack.data.dmg+" damage."):Log.append(log,_defr.name+" blocks the attack."):Log.append(log,_defr.name+" dodges the attack."),attack.data.dmg>=mode.defrhp.value&&allied(mode.data.source,_defr)?Log.append(log,_defr.name+" is defeated."):attack.data.dmg>=mode.defrhp.value&&!allied(mode.data.source,_defr)&&Log.append(log,"Defeated "+_defr.name+".")):duration.done&&(duration=1===mode.attacks.length?70:50,screen.time-attack.time>=duration&&(mode.attacks.shift(),mode.anim=null)):(attack.time=screen.time,attack.init||init(attack,mode),center(camera,screen.map,_defr.cell),camera.target.y-=camera.height/2,camera.target.y+=(camera.height-44)/2,attack.connect=!1)):mode.exit||(mode.exit=!0,mode.onend&&mode.onend())}}),Home=getAugmentedNamespace(irving),irving=getAugmentedNamespace(troll2),troll2=getAugmentedNamespace(eileen),eileen=getAugmentedNamespace(goblin1),goblin1={Home:Home,Select:irving,Forecast:troll2,Attack:eileen},Modes=Object.freeze(Object.assign(Object.create(null),goblin1,{default:goblin1,Home:Home,Select:irving,Forecast:troll2,Attack:eileen}));function move$1(unit,dest){unit.cell=dest}function attack$1(removal,game){removal=attack(removal.source,removal.target,{map:game.map,data:removal});return removal&&function(unit,game){var _iteratorNormalCompletion14=!0,_didIteratorError14=!1,p=void 0;try{for(var _iterator14=game.map.units[Symbol.iterator]();!(_iteratorNormalCompletion14=(other=_iterator14.next()).done);_iteratorNormalCompletion14=!0){var other=other.value;other.control.convert===unit&&(other.control={faction:"player"},"player"===game.phase.faction&&game.phase.pending.push(other))}}catch(err){_didIteratorError14=!0,p=err}finally{try{!_iteratorNormalCompletion14&&_iterator14.return&&_iterator14.return()}finally{if(_didIteratorError14)throw p}}p=game.map.units.indexOf(unit);-1!==p&&game.map.units.splice(p,1);p=game.phase.pending.indexOf(unit);-1!==p&&game.phase.pending.splice(p,1)}(removal,game),removal}function switchPhase(game){var map=game.map,phase=game.phase;"player"===phase.faction?phase.faction="enemy":"enemy"===phase.faction&&(phase.faction="player"),phase.pending=map.units.filter(function(unit){return unit.control.faction===phase.faction}),phase.pending.length||switchPhase(game)}var aifuncs={attack:function(unit,path){var dest=findRange(unit,path),moves=guard(unit,path,{range:dest});if(moves.length)return moves;var target=path.units.filter(function(other){return"player"===other.control.faction}).sort(function(a,b){return steps(a.cell,unit.cell)-steps(b.cell,unit.cell)})[0];if(!target)return[];var moves=dest.squares.filter(function(square){return"move"===square.type}).map(function(square){return square.cell}),opts={width:path.width,height:path.height,blacklist:unwalkables(path,unit)},paths=moves.map(function(cell){return pathfind(target.cell,cell,opts)}),dest=moves.map(function(_,i){return i});dest.sort(function(a,b){return paths[a].length-paths[b].length});dest=dest[0],dest=moves[dest],path=pathfind$1(unit,dest,path);return[{type:"move",unit:unit,path:path}]},guard:guard,wait:function(unit,map){var cmd=[],targets=neighborhood(unit.cell,unit.wpn.rng).map(function(cell){return map.units.find(function(unit){return equals(cell,unit.cell)})}).filter(function(target){return!!target&&!allied(unit,target)}),target=targets[0];{var _attack$;target&&(_attack$=attackData(unit,target),attack(unit,target,{map:map,data:_attack$}),cmd.push({type:"attack",attack:_attack$}),console.log(unit.name,"can target",targets.map(function(target){return target.name}).join(", ")),console.log("Chose",target.name,_attack$))}return cmd}};function guard(unit,path,_attack3){var range=(_attack3=Object.assign({},_attack3)).range,_attack3=(range=range||findRange(unit,path)).squares.filter(function(square){return square.target&&"player"===square.target.control.faction}).map(function(square){return square.target})[0];if(!_attack3)return[];if(inRange(steps(unit.cell,_attack3.cell),unit.wpn.rng))return[{type:"attack",attack:attackData(unit,_attack3)}];for(var _neighbors2=neighborhood(_attack3.cell,unit.wpn.rng).filter(function(cell){return range.squares.find(function(square){return"move"===square.type&&equals(square.cell,cell)})}).sort(function(a,b){return steps(a,unit.cell)-steps(b,unit.cell)}),dest=_neighbors2.shift();!dest&&_neighbors2.length;)dest=_neighbors2.shift();if(!dest)return[];path=pathfind$1(unit,dest,path);unit.cell=dest;_attack3=attackData(unit,_attack3);return[{type:"move",unit:unit,path:path},{type:"attack",unit:unit,attack:_attack3}]}function endTurn$1(cmd,screen){var next=screen.data.phase,_screen$commands=screen.cache;if(!function(index,game){var pending=game.phase.pending;pending.length?-1!==(index=pending.indexOf(index))&&(pending.splice(index,1),pending.length||switchPhase(game)):switchPhase(game)}(cmd,screen.data),_screen$commands.unitcell=null,console.log("ended",cmd.name+"'s turn"),console.log(next.pending.map(function(unit){return unit.name}).join(", "),"remains"),(cmd=console).log.apply(cmd,["commands left"].concat(_toConsumableArray(screen.commands))),screen.commands.length||screen.commands.push({type:"switchMode",mode:"Home"}),next.faction!==_screen$commands.phase){if(_screen$commands.phase=next.faction,"enemy"===next.faction&&next.pending.length){cmd=function(screen){for(var cmd=[],_didIteratorError16=screen.data,_iteratorError16=_didIteratorError16.map,phase=_didIteratorError16.phase,strategy=function(map,units){for(var mapcopy={width:map.width,height:map.height,layout:map.layout,units:map.units.map(function(unit){return Object.assign({real:unit},unit)})},indices=units.map(function(unit){return map.units.indexOf(unit)}),strategy=mapcopy.units.filter(function(unit,index){return indices.includes(index)&&unit.control.ai}).map(function(unit){return aifuncs[unit.control.ai](unit,mapcopy)}),i=0;i<strategy.length;i++){var sequence=strategy[i],_iteratorNormalCompletion15=(units[i],!0),_didIteratorError15=!1,_iteratorError15=void 0;try{for(var _iterator15=sequence[Symbol.iterator]();!(_iteratorNormalCompletion15=(counter=_iterator15.next()).done);_iteratorNormalCompletion15=!0){var counter=counter.value;"move"===counter.type?counter.unit=counter.unit.real:"attack"!==counter.type||(counter=counter.attack)&&(counter.source=counter.source.real,counter.target=counter.target.real,counter.counter&&((counter=counter.counter).source=counter.source.real,counter.target=counter.target.real))}}catch(err){_didIteratorError15=!0,_iteratorError15=err}finally{try{!_iteratorNormalCompletion15&&_iterator15.return&&_iterator15.return()}finally{if(_didIteratorError15)throw _iteratorError15}}}return strategy}(_iteratorError16,phase.pending),stratmap=new Map,i=0;i<strategy.length;i++){var commands=strategy[i],_unit3=phase.pending[i];stratmap.set(_unit3,commands)}var _iteratorNormalCompletion16=!0,_didIteratorError16=!1,_iteratorError16=void 0;try{for(var _iterator16=stratmap[Symbol.iterator]();!(_iteratorNormalCompletion16=(_unit4=_iterator16.next()).done);_iteratorNormalCompletion16=!0){var _commands=_unit4.value,_console4=_slicedToArray(_commands,2),_unit4=_console4[0],_commands=_console4[1];(_console4=console).log.apply(_console4,[_unit4.name].concat(_toConsumableArray(_commands))),_commands.length?cmd.push.apply(cmd,_toConsumableArray(_commands)):(console.log("no commands for",_unit4.name),endTurn$1(_unit4,screen))}}catch(err){_didIteratorError16=!0,_iteratorError16=err}finally{try{!_iteratorNormalCompletion16&&_iterator16.return&&_iterator16.return()}finally{if(_didIteratorError16)throw _iteratorError16}}return cmd}(screen);if((_screen$commands=screen.commands).push.apply(_screen$commands,_toConsumableArray(cmd)),!cmd.length)return}next=next.pending[0];next&&center(screen.camera,screen.map,next.cell)}}function updateCamera(screen){var camera=screen.camera,cache=screen.cache;Math.round(cache.camera.x)===Math.round(camera.pos.x)&&Math.round(cache.camera.y)===Math.round(camera.pos.y)||(cache.camera.x=camera.pos.x,cache.camera.y=camera.pos.y,screen.dirty=!0),function(camera){camera.pos.x+=camera.vel.x,camera.pos.y+=camera.vel.y,camera.vel.x+=((camera.target.x-camera.pos.x)/8-camera.vel.x)/2,camera.vel.y+=((camera.target.y-camera.pos.y)/8-camera.vel.y)/2}(screen.camera)}function updateModeComps(mode,screen){for(var dirty=!1,c=0;c<mode.comps.length;c++){var comp=mode.comps[c],anim=comp.anim;anim&&(anim.done?comp.anim=null:Anims[anim.id].update(anim),dirty=!0),!comp.anim&&comp.exit?mode.comps.splice(c--,1):Comps[comp.id].onupdate&&Comps[comp.id].onupdate(comp,screen)}return dirty}function transition(screen,nextid,_didIteratorError17){if(!Modes[nextid])throw new Error("Attempting to switch to nonexistent mode "+nextid);var mode=screen.mode,next=screen.nextmode=Modes[nextid].create(_didIteratorError17);next.time=screen.time;var _iteratorError17=Modes[mode.id].onexit;_iteratorError17&&_iteratorError17(mode,screen);var _iteratorNormalCompletion17=mode.exit=!0,_didIteratorError17=!1,_iteratorError17=void 0;try{for(var _iterator17=mode.comps[Symbol.iterator]();!(_iteratorNormalCompletion17=(comp=_iterator17.next()).done);_iteratorNormalCompletion17=!0){var comp=comp.value;Comps[comp.id].exit(comp)}}catch(err){_didIteratorError17=!0,_iteratorError17=err}finally{try{!_iteratorNormalCompletion17&&_iterator17.return&&_iterator17.return()}finally{if(_didIteratorError17)throw _iteratorError17}}mode.comps.filter(function(comp){return comp.exit&&comp.blocking}).length||switchMode(screen),Modes[nextid].onenter&&Modes[nextid].onenter(next,screen),screen.dirty=!0}function switchMode(screen){screen.mode=screen.nextmode,screen.nextmode=null,screen.dirty=!0}var screens={Game:getAugmentedNamespace(Object.freeze({__proto__:null,tilesize:16,layerseq:["map","range","shadows","arrow","ring","pieces","cursor","selection","mirage","ui"],create:function(data){return{id:"Game",mode:Home.create(),nextmode:null,commands:[],comps:[],anims:[],view:null,time:0,wait:0,dirty:!1,camera:{width:0,height:0,zoom:0,pos:{x:0,y:0},vel:{x:0,y:0},target:{x:0,y:0},origin:{x:0,y:0},offset:{x:0,y:0}},map:Object.assign({tilesize:16,image:null},data.map),data:data,cache:{camera:{x:0,y:0},phase:"player",units:data.map.units.slice(),unitcell:null}}},onenter:function(camera,view){var unit=view.sprites;camera.view=view,camera.map.image=function(map,canvas){var palette=canvas.palette,context=(canvas=document.createElement("canvas")).getContext("2d");canvas.width=map.width*map.tilesize,canvas.height=map.height*map.tilesize,context.fillRect(0,0,canvas.width,canvas.height);for(var i=0;i<map.height;i++)for(var _x11,_y12,color,j=0;j<map.width;j++){at(map,{x:j,y:i}).walkable&&(_x11=j*map.tilesize,_y12=i*map.tilesize,color=(j+i)%2?palette.jet:palette.coal,context.fillStyle=rgb.apply(void 0,_toConsumableArray(color)),context.fillRect(_x11,_y12,map.tilesize,map.tilesize))}return canvas}(camera.map,unit),unit=camera.data.phase.pending[0],center(camera.camera,camera.map,unit.cell),(camera=camera.camera).pos.x=camera.target.x,camera.pos.y=camera.target.y},onresize:function(screen,viewport){screen.camera.width=viewport.width,screen.camera.height=viewport.height,screen.camera.zoom=viewport.scale;var onresize=Modes[screen.mode.id].onresize;onresize&&onresize(screen.mode,viewport)},onpress:function(screen,pointer){(onpress=screen.camera).offset={x:onpress.pos.x*onpress.zoom,y:onpress.pos.y*onpress.zoom};var onpress=Modes[screen.mode.id].onpress;onpress&&onpress(screen.mode,screen,pointer)},onmove:function(screen,pointer){var onmove=Modes[screen.mode.id].onmove;onmove&&onmove(screen.mode,screen,pointer)},onrelease:function(screen,pointer){if("click"===pointer.mode){var onrelease=screen.view.viewport,pos={x:pointer.pos.x/onrelease.scale,y:pointer.pos.y/onrelease.scale},onrelease=screen.mode.comps.find(function(bbox){return bbox.bbox&&(point=pos,bbox=bbox.bbox,point.x>=bbox.left&&point.y>=bbox.top&&point.x<bbox.right&&point.y<bbox.bottom);var point});if(onrelease)return void Comps[onrelease.id].onclick(onrelease,screen)}(onrelease=Modes[screen.mode.id].onrelease)&&onrelease(screen.mode,screen,pointer)},onupdate:function(screen){var mode=screen.mode,nextmode=screen.nextmode;screen.time++,screen.wait=Math.max(0,screen.wait-1),updateCamera(screen);var _command=screen.anims.find(function(anim){return anim.blocking})||mode.comps.filter(function(comp){return comp.exit&&comp.blocking}).length||screen.wait;screen.dirty|=function(screen){for(var dirty=!1,i=0;i<screen.anims.length;i++){var onend,anim=screen.anims[i];anim.done?(screen.anims.splice(i--,1),(onend=anim.opts&&anim.opts.onend)&&onend()):Anims[anim.id].update(anim),dirty=!0}return dirty}(screen),screen.dirty|=function(mode,_screen$anims){if(mode.anims.length){return(_screen$anims=_screen$anims.anims).push.apply(_screen$anims,_toConsumableArray(mode.anims)),!(mode.anims.length=0)}}(mode,screen),screen.dirty|=updateModeComps(mode,screen),nextmode&&(screen.dirty|=updateModeComps(nextmode,screen),!_command&&nextmode&&switchMode(screen));var command=Modes[mode.id].onupdate;command&&command(mode,screen),mode.commands.length&&(command=mode.commands.shift(),console.log(screen.time,"cmd mode "+mode.id,command),"select"===command.type?screen.commands.push({type:"switchMode",mode:"Select",data:command.data}):"forecast"===command.type?screen.commands.push({type:"switchMode",mode:"Forecast",data:{unit:command.unit,target:command.target}}):"cancel"===command.type?screen.commands.push({type:"switchMode",mode:"Home"}):screen.commands.push(command)),(_command=screen.anims.find(function(anim){return anim.blocking})||"Attack"===mode.id&&!mode.exit||mode.comps.filter(function(comp){return comp.exit&&comp.blocking}).length||screen.wait)||(screen.commands.length?(_command=screen.commands.shift(),console.log(screen.time,"cmd screen",_command),"move"===_command.type?function(unit,path,screen){var move=PieceMove.create(path,{unit:unit,onend:function(){var acting=path[path.length-1];move$1(unit,acting,screen.data);acting=screen.commands[0],acting=acting&&acting.unit===unit;("enemy"!==screen.data.phase.faction||acting)&&"Forecast"!==screen.mode.id||endTurn$1(unit,screen)}});screen.anims.push(move),screen.cache.unitcell=unit.cell}(_command.unit,_command.path,screen):"attack"===_command.type?function(unit,attack,screen){transition(screen,"Attack",{attack:attack,onend:function(){var removal=attack$1(attack,screen.data);removal&&(command=PieceFade.create({unit:removal}),screen.anims.push(command)),(command=console).log.apply(command,["commands left"].concat(_toConsumableArray(screen.commands)));var command=screen.commands[0];command&&command.unit===unit||endTurn$1(unit,screen),screen.commands.length&&screen.commands[0]&&"attack"===screen.commands[0].type||screen.nextmode||transition(screen,"Home")}})}(_command.unit,_command.attack,screen):"endTurn"===_command.type?endTurn$1(_command.unit,screen):"cancel"===_command.type?(function(unit,screen){var cache=screen.cache;screen.data;if(!cache.unitcell)throw new Error("Failed to cancel selection: No origin cell in memory");move$1(unit,cache.unitcell),cache.unitcell=null}(_command.unit,screen),nextmode||transition(screen,"Home")):"switchMode"===_command.type&&(nextmode||transition(screen,_command.mode,_command.data))):"Home"!==mode.id&&"Forecast"!==mode.id&&"Select"!==mode.id&&(nextmode||transition(screen,"Home")))},updateCamera:updateCamera,render:function(screen){var nodes=[],map=screen.map,mode=screen.mode,_iteratorError20=screen.nextmode,camera=(screen.cache,screen.camera),game=screen.data,sprites=screen.view.sprites,origin=camera.origin=function(map,camera){return{x:camera.width/2-map.width*map.tilesize/2+camera.pos.x,y:camera.height/2-map.height*map.tilesize/2+camera.pos.y}}(map,screen.camera);Modes[mode.id].render&&(_didIteratorError20=Modes[mode.id].render(mode,screen),nodes.push.apply(nodes,_toConsumableArray(_didIteratorError20))),nodes.push({image:map.image,layer:"map",x:origin.x,y:origin.y});var comps=mode.comps.slice();_iteratorError20&&comps.push.apply(comps,_toConsumableArray(_iteratorError20.comps));var _iteratorNormalCompletion18=!0,_didIteratorError20=!1,_iteratorError20=void 0;try{for(var _iterator18=comps[Symbol.iterator]();!(_iteratorNormalCompletion18=(compnodes=_iterator18.next()).done);_iteratorNormalCompletion18=!0){var compnodes=compnodes.value,compnodes=Comps[compnodes.id].render(compnodes,screen);nodes.push.apply(nodes,_toConsumableArray(compnodes))}}catch(err){_didIteratorError20=!0,_iteratorError20=err}finally{try{!_iteratorNormalCompletion18&&_iterator18.return&&_iterator18.return()}finally{if(_didIteratorError20)throw _iteratorError20}}var select="Select"===mode.id||"Forecast"===mode.id||"Attack"===mode.id,_iteratorNormalCompletion19=!0,_didIteratorError20=!1,_iteratorError20=void 0;try{for(var _step19,_iterator19=map.units[Symbol.iterator]();!(_iteratorNormalCompletion19=(_step19=_iterator19.next()).done);_iteratorNormalCompletion19=!0)(function(_unit5){if(screen.anims.find(function(anim){return anim.opts&&anim.opts.unit===_unit5}))return;var sprite=sprites.pieces[_unit5.control.faction][_unit5.type],y=_unit5.cell,x=origin.x+y.x*map.tilesize,y=origin.y+y.y*map.tilesize;"player"===game.phase.faction&&"player"===_unit5.control.faction&&(game.phase.pending.includes(_unit5)?mode.unit===_unit5||mode.target===_unit5||"Home"!==mode.id&&"Select"!==mode.id||nodes.push({layer:"pieces",image:sprites.select.glow[_unit5.control.faction],x:x,y:y-2}):select&&(mode.unit===_unit5||mode.target===_unit5)||(sprite=sprites.pieces.done[_unit5.control.faction][_unit5.type])),nodes.push({layer:"pieces",image:sprite,x:x+1,y:y-1,z:0}),nodes.push({layer:"shadows",image:sprites.pieces.shadow,x:x+1,y:y+3})})(_step19.value)}catch(err){_didIteratorError20=!0,_iteratorError20=err}finally{try{!_iteratorNormalCompletion19&&_iterator19.return&&_iterator19.return()}finally{if(_didIteratorError20)throw _iteratorError20}}var _iteratorNormalCompletion20=!0,_didIteratorError20=!1,_iteratorError20=void 0;try{for(var _iterator20=screen.anims[Symbol.iterator]();!(_iteratorNormalCompletion20=(_x12=_iterator20.next()).done);_iteratorNormalCompletion20=!0){var anim=_x12.value,_y13=anim.opts.unit,_sprite=sprites.pieces[_y13.control.faction][_y13.type],z=anim.cell||anim.opts.unit.cell,_x12=origin.x+z.x*map.tilesize,_y13=origin.y+z.y*map.tilesize,z=0;"PieceLift"!==anim.id&&"PieceDrop"!==anim.id||(z=Math.round(anim.y)),"PieceFlinch"!==anim.id||anim.flashing||(_sprite=sprites.pieces.flash),"PieceFade"===anim.id&&!anim.visible||("PieceMove"!==anim.id&&"PieceAttack"!==anim.id&&"PieceFlinch"!==anim.id||(_x12=origin.x+anim.cell.x*map.tilesize,_y13=origin.y+anim.cell.y*map.tilesize),"PieceMove"===anim.id&&center(camera,map,anim.cell),nodes.push({layer:"selection",image:_sprite,x:_x12+1,y:_y13-1,z:z}),nodes.push({layer:"shadows",image:sprites.pieces.shadow,x:_x12+1,y:_y13+3}))}}catch(err){_didIteratorError20=!0,_iteratorError20=err}finally{try{!_iteratorNormalCompletion20&&_iterator20.return&&_iterator20.return()}finally{if(_didIteratorError20)throw _iteratorError20}}return nodes}}))};function getPosition(y){var x=y.pageX||y.touches&&y.touches[0].pageX,y=y.pageY||y.touches&&y.touches[0].pageY;return void 0===x||void 0===y?null:{x:x,y:y}}function init$1(view,game){var viewport=view.viewport,sprites=view.sprites,pointer=view.pointer,screen=screens.Game.create(game,sprites);screens.Game.onenter(screen,view);(view.screen=screen).map;var device=null,events={resize:function(){var scaleX=Math.max(1,Math.floor(window.innerWidth/view.native.width)),onresize=Math.max(1,Math.floor(window.innerHeight/view.native.height));viewport.scale=Math.min(scaleX,onresize),viewport.width=Math.ceil(window.innerWidth/viewport.scale),viewport.height=Math.ceil(window.innerHeight/viewport.scale);onresize=view.element;onresize.width=viewport.width,onresize.height=viewport.height,onresize.style.transform="scale("+viewport.scale+")";onresize=screens[screen.id].onresize;onresize&&onresize(screen,viewport),view.dirty=!0},press:function(onpress){if(device=device||function(event){var device="desktop";event.touches?(device="mobile",window.removeEventListener("mousedown",events.press),window.removeEventListener("mousemove",events.move),window.removeEventListener("mouseup",events.release)):(window.removeEventListener("touchstart",events.press),window.removeEventListener("touchmove",events.move),window.removeEventListener("touchend",events.release));return device}(onpress),pointer.presspos)return!1;if(pointer.pos=getPosition(onpress),!pointer.pos)return!1;pointer.time=view.time,pointer.mode="click",pointer.presspos=pointer.pos;onpress=screens[screen.id].onpress;onpress&&(onpress(screen,pointer),screen.dirty&&(view.dirty=!0))},move:function(p1){if(pointer.pos=getPosition(p1),!pointer.pos||!pointer.presspos)return!1;var p2;"click"===pointer.mode&&(p2=pointer.pos,p1=pointer.presspos,p1=p1,p2=p2,Math.pow(p2.x-p1.x,2)+Math.pow(p2.y-p1.y,2)>Math.pow(3,2)&&(pointer.mode="drag")),screens[screen.id].onmove&&(screens[screen.id].onmove(screen,pointer),screen.dirty&&(view.dirty=!0))},release:function(){if(!pointer.presspos)return!1;var onrelease=screens[screen.id].onrelease;onrelease&&(onrelease(screen,pointer),screen.dirty&&(view.dirty=!0)),pointer.mode=null,pointer.presspos=null}};events.resize(),window.addEventListener("resize",events.resize),window.addEventListener("mousedown",events.press),window.addEventListener("mousemove",events.move),window.addEventListener("mouseup",events.release),window.addEventListener("touchstart",events.press),window.addEventListener("touchmove",events.move),window.addEventListener("touchend",events.release),requestAnimationFrame(function update(){var screen=view.screen;screen.dirty&&(screen.dirty=!1,view.dirty=!0),view.dirty&&(view.dirty=!1,function(screennodes){var screen=screennodes.element,context=screen.getContext("2d");context.fillStyle="black",context.fillRect(0,0,screen.width,screen.height);var nodes=screennodes.cache.nodes;nodes.length=0,screen=screennodes.screen,screennodes=screens[screen.id].render(screen,screennodes),nodes.push.apply(nodes,_toConsumableArray(screennodes)),function(nodes,layerseq,context){nodes.sort(function(a,b){return zindex(a)-zindex(b)});var _iteratorNormalCompletion21=!0,_didIteratorError21=!1,_iteratorError21=void 0;try{for(var _iterator21=nodes[Symbol.iterator]();!(_iteratorNormalCompletion21=(_height5=_iterator21.next()).done);_iteratorNormalCompletion21=!0){var _x13,_y14,width,_height5,node=_height5.value,image=bbox(node);image&&(_x13=Math.round(image.left),_y14=Math.round(image.top),width=Math.round(image.width),_height5=Math.round(image.height),image=node.image,void 0!==node.opacity?(context.globalAlpha=node.opacity,context.drawImage(image,_x13,_y14,width,_height5),context.globalAlpha=1):context.drawImage(image,_x13,_y14,width,_height5))}}catch(err){_didIteratorError21=!0,_iteratorError21=err}finally{try{!_iteratorNormalCompletion21&&_iterator21.return&&_iterator21.return()}finally{if(_didIteratorError21)throw _iteratorError21}}function zindex(node){var z=layerseq.indexOf(node.layer),y=node.height||node.image.height,y=node.y+y/2;return"ui"===node.layer&&(y=0),z*context.canvas.height+y}}(nodes,screens[screen.id].layerseq,context)}(view)),requestAnimationFrame(update);var onupdate=screens[screen.id].onupdate;onupdate&&onupdate(screen)})}var path,goblin1=["Goblin","thief",{faction:"enemy",ai:"wait"},{hp:6,atk:5,hit:6,def:2,spd:7,res:5,element:"dark"}],irving=["Irving","fighter",{faction:"ally",ai:"wait",convert:goblin1},{hp:14,atk:7,hit:6,def:2,spd:3,res:0,element:"fire"}],troll2=["Troll","knight",{faction:"enemy",ai:"wait"},{hp:14,atk:7,hit:8,def:6,spd:0,res:3,element:"dark"}],eileen=["Eileen","thief",{faction:"ally",ai:"wait",convert:troll2},{hp:9,atk:5,hit:8,def:1,spd:7,res:6,element:"ice"}],state=function(map){for(var units=map.units.map(function(unit){return create$m.apply(void 0,_toConsumableArray(unit))}),i=0;i<units.length;i++)!function(index){var unit=units[index];unit.control.convert&&(index=map.units.find(function(other){return unit.control.convert[2]===other[2]}),index=map.units.indexOf(index),unit.control.convert=units[index]),"wait"===unit.control.ai&&"enemy"===unit.control.faction&&(unit.stats.mov=0)}(i);return{map:function(width,height,layoutdata,units){for(var layout=[],_y6=height;_y6--;)for(var _x6=width;_x6--;){var index=_y6*width+_x6,char=layoutdata[index];layout[index]=tiles[char]}return{width:width,height:height,layout:layout,units:units}}(map.width,map.height,map.layout,units),phase:{faction:"player",pending:units.filter(function(unit){return"player"===unit.control.faction})}}}({id:"test",width:16,height:24,layout:["###        #####","###        #####","##        ######","##        ######","####     #######","####     ###   #","####     ##    #","#####    ##   ##","#####     # ####","######      ####","#######       ##","##########     #","###  ######     ","##   ######     ","##      ##     #","##  ##         #","######        ##","#####       ####","####        ####","####       #####","####       #####","###       ######","###       ######","##        ######"].join(""),units:[[].concat(["Chorizo","soldier",{faction:"player"},{hp:11,atk:6,hit:9,def:3,spd:5,res:4,element:"plant"}],[{x:5,y:21}]),[].concat(["Gemma","mage",{faction:"player"},{hp:7,atk:7,hit:8,def:2,spd:4,res:6,element:"volt"}],[{x:7,y:22}]),[].concat(["Orc","fighter",{faction:"enemy",ai:"attack"},{hp:10,atk:7,hit:6,def:1,spd:4,res:2,element:"volt"}],[{x:8,y:18}]),[].concat(["Troll","knight",{faction:"enemy",ai:"attack"},{hp:11,atk:7,hit:6,def:5,spd:2,res:3,element:"fire"}],[{x:12,y:11}]),[].concat(goblin1,[{x:5,y:14}]),[].concat(irving,[{x:3,y:13}]),[].concat(["Kobold","archer",{faction:"enemy",ai:"attack"},{hp:9,atk:6,hit:6,def:2,spd:4,res:1,element:"dark"}],[{x:7,y:8}]),[].concat(troll2,[{x:11,y:8}]),[].concat(eileen,[{x:12,y:7}]),[].concat(["Orc","fighter",{faction:"enemy",ai:"guard"},{hp:12,atk:7,hit:5,def:1,spd:4,res:2,element:"dark"}],[{x:13,y:13}]),[].concat(["Orc","fighter",{faction:"enemy",ai:"attack"},{hp:11,atk:8,hit:4,def:0,spd:5,res:1,element:"dark"}],[{x:3,y:1}]),[].concat(["Skeleton","soldier",{faction:"enemy",ai:"guard"},{hp:13,atk:7,hit:6,def:2,spd:4,res:1,element:"dark"}],[{x:6,y:5}]),[].concat(["Goblin","thief",{faction:"enemy",ai:"guard"},{hp:9,atk:3,hit:8,def:2,spd:7,res:3,element:"dark"}],[{x:4,y:6}]),[].concat(["Golem","knight",{faction:"enemy",ai:"guard"},{hp:15,atk:8,hit:8,def:8,spd:1,res:5,element:"dark"}],[{x:8,y:0}]),[].concat(["Lagan","fighter",{faction:"enemy",ai:"guard"},{hp:15,atk:9,hit:5,def:3,spd:4,res:4,element:"dark"}],[{x:7,y:2}]),[].concat(["Shiva","mage",{faction:"enemy",ai:"wait"},{hp:15,atk:9,hit:9,def:4,spd:4,res:6,element:"dark"}],[{x:6,y:1}])]});path="sprites.png",new Promise(function(resolve,reject){var image=new Image;image.src=path,image.onload=function(){resolve(image)},image.onerror=function(){reject(new Error("Failed to load image `"+path+"`"))}}).then(function(view){view=function(width,height,sprites){return{native:{width:width,height:height},sprites:sprites,element:document.createElement("canvas"),screen:null,time:0,cache:{nodes:[]},viewport:{width:window.innerWidth,height:window.innerHeight,scale:1},pointer:{pos:null,presspos:null,mode:null,time:0}}}(160,160,normalize(view));document.body.appendChild(view.element),init$1(view,state)})}();